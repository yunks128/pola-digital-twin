<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Port of Los Angeles - Digital Twin Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1e293b;
            min-height: 100vh;
            font-size: 14px;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr 360px;
            grid-template-rows: 80px 1fr 180px;
            height: 100vh;
            gap: 1px;
            background: #e2e8f0;
        }

        /* Mobile Layout - Stack vertically on small screens */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 50vh auto auto auto;
                height: 100vh;
                min-height: 100vh;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-view {
                order: 1;
                height: 50vh;
                min-height: 50vh;
                max-height: 50vh;
                overflow: hidden;
            }
            
            .control-panel {
                order: 3;
            }
            
            .status-dashboard {
                order: 4;
            }
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            border-bottom: 2px solid #0ea5e9;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .header-title {
            color: #1e293b;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 2px;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        /* Mobile Header Styles */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                height: 60px;
            }
            
            .logo {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .header-title {
                font-size: 1rem;
            }
            
            .header-subtitle {
                font-size: 0.75rem;
            }
            
            .header-info {
                gap: 1rem;
            }
            
            .status-indicator {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: relative;
        }

        .status-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }

        .online { background: #10b981; }
        .online::before { background: #10b981; }
        .warning { background: #f59e0b; }
        .warning::before { background: #f59e0b; }
        .critical { background: #ef4444; }
        .critical::before { background: #ef4444; }

        @keyframes pulse-ring {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2.5); }
        }

        .sidebar {
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .main-view {
            background: #f8fafc;
            position: relative;
            overflow: hidden;
        }

        /* Mobile Main View */
        @media (max-width: 768px) {
            .main-view {
                min-height: 50vh;
                max-height: 50vh;
                overflow: hidden;
                position: relative;
            }
            
            .port-map-container {
                height: 100%;
                width: 100%;
                position: relative;
                overflow: hidden;
            }
            
            #googleMap {
                width: 100% !important;
                height: 100% !important;
                border-radius: 0;
                position: absolute;
                top: 0;
                left: 0;
                transform: none;
                transition: none;
            }
            
            .map-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: auto;
            }
            
            .data-overlay {
                position: absolute;
                bottom: 10px;
                left: 10px;
                right: 10px;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border-radius: 8px;
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .data-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .data-item {
                padding: 0.3rem;
            }
            
            .vessel-marker {
                transform: scale(0.8);
            }
            
            .alert-label {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
                max-width: 120px;
            }
            
            .structure-label {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
            }
        }

        .control-panel {
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            border-left: 1px solid #e2e8f0;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .footer-panel {
            grid-column: 1 / -1;
            background: white;
            padding: 1rem 2rem;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            color: #0f172a;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Mobile Sidebar Styles */
        @media (max-width: 768px) {
            .sidebar, .control-panel {
                padding: 1rem;
                max-height: none;
                overflow: visible;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .agent-card, .metric-card {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
            }
            
            .agent-name, .metric-label {
                font-size: 0.85rem;
            }
            
            .confidence-level, .metric-value {
                font-size: 0.8rem;
            }
        }

        .agent-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #0ea5e9;
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .agent-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .agent-status {
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-auto {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .status-sync {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .agent-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .confidence-bar {
            width: 100%;
            height: 3px;
            background: #f1f5f9;
            border-radius: 2px;
            margin-top: 0.8rem;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .port-map-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .google-map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* Port of Los Angeles Background Layout */
        .port-infrastructure {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* Landmass */
        .landmass {
            position: absolute;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 50%, #d1d5db 100%);
            border: 2px solid #9ca3af;
        }

        .main-land {
            top: 0;
            left: 0;
            width: 100%;
            height: 25%;
            border-radius: 0 0 20px 0;
        }

        .terminal-island-land {
            top: 40%;
            left: 15%;
            width: 35%;
            height: 35%;
            border-radius: 15px;
        }

        .san-pedro-land {
            top: 70%;
            left: 0;
            width: 50%;
            height: 30%;
            border-radius: 0 15px 0 0;
        }

        /* Water channels and harbors */
        .inner-harbor {
            position: absolute;
            top: 25%;
            left: 10%;
            width: 80%;
            height: 40%;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            border: 1px dashed #3b82f6;
        }

        .main-channel {
            position: absolute;
            top: 15%;
            left: 5%;
            width: 90%;
            height: 8px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .approach-channel {
            position: absolute;
            top: 10%;
            left: 85%;
            width: 15%;
            height: 6px;
            background: linear-gradient(90deg, #1d4ed8, #1e40af);
            border-radius: 4px;
        }

        /* Breakwater */
        .outer-breakwater {
            position: absolute;
            top: 12%;
            left: 8%;
            width: 75%;
            height: 4px;
            background: #6b7280;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .middle-breakwater {
            position: absolute;
            top: 18%;
            left: 15%;
            width: 60%;
            height: 3px;
            background: #6b7280;
            border-radius: 2px;
        }

        /* Terminals with realistic positioning */
        .terminal {
            position: absolute;
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            border: 2px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .terminal:hover {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-color: #0ea5e9;
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 8px 16px rgba(14, 165, 233, 0.3);
        }

        /* Actual Port of LA Terminal Layout */
        .terminal-island {
            top: 42%;
            left: 18%;
            width: 28%;
            height: 10%;
        }

        .pier-a {
            top: 33%;
            left: 12%;
            width: 18%;
            height: 8%;
        }

        .pier-b {
            top: 52%;
            left: 8%;
            width: 22%;
            height: 8%;
        }

        .pier-c {
            top: 60%;
            left: 22%;
            width: 20%;
            height: 8%;
        }

        .pier-s {
            top: 38%;
            left: 48%;
            width: 22%;
            height: 10%;
        }

        .pier-t {
            top: 28%;
            left: 72%;
            width: 18%;
            height: 12%;
        }

        /* Container yards */
        .container-yard {
            position: absolute;
            background: repeating-linear-gradient(
                45deg,
                #f3f4f6,
                #f3f4f6 3px,
                #e5e7eb 3px,
                #e5e7eb 6px
            );
            border: 1px solid #d1d5db;
            border-radius: 3px;
        }

        .yard-1 {
            top: 26%;
            left: 20%;
            width: 24%;
            height: 6%;
        }

        .yard-2 {
            top: 50%;
            left: 48%;
            width: 20%;
            height: 8%;
        }

        /* Ship icons using CSS */
        .vessel-marker {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
        }

        .vessel-marker:hover {
            transform: scale(1.3);
            z-index: 20;
        }

        .vessel-container {
            width: 24px;
            height: 8px;
            background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 2px 8px 8px 2px;
            border: 1px solid #0369a1;
            box-shadow: 0 2px 4px rgba(3, 105, 161, 0.3);
            position: relative;
        }

        .vessel-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 2px;
            width: 4px;
            height: 3px;
            background: #0369a1;
            border-radius: 1px;
        }

        .vessel-container::after {
            content: '';
            position: absolute;
            top: -2px;
            right: 2px;
            width: 6px;
            height: 3px;
            background: #0369a1;
            border-radius: 1px;
        }

        .vessel-tanker {
            width: 28px;
            height: 10px;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            border-radius: 3px 10px 10px 3px;
            border: 1px solid #b45309;
            box-shadow: 0 2px 4px rgba(180, 83, 9, 0.3);
            position: relative;
        }

        .vessel-tanker::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 3px;
            width: 20px;
            height: 2px;
            background: #b45309;
            border-radius: 1px;
        }

        .vessel-tanker::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 3px;
            width: 20px;
            height: 2px;
            background: #b45309;
            border-radius: 1px;
        }

        .vessel-cargo {
            width: 20px;
            height: 7px;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 2px 6px 6px 2px;
            border: 1px solid #047857;
            box-shadow: 0 2px 4px rgba(4, 120, 87, 0.3);
            position: relative;
        }

        .vessel-cargo::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 2px;
            width: 3px;
            height: 2px;
            background: #047857;
            border-radius: 1px;
        }

        .vessel-cargo::after {
            content: '';
            position: absolute;
            top: -1px;
            right: 3px;
            width: 4px;
            height: 2px;
            background: #047857;
            border-radius: 1px;
        }

        /* Sonar ping effect for vessels */
        .vessel-marker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150%;
            height: 150%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            animation: sonar-ping 4s infinite;
            pointer-events: none;
        }

        @keyframes sonar-ping {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(3); }
        }

        /* Navigation aids */
        .navigation-light {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ef4444;
            border-radius: 50%;
            animation: nav-blink 2s infinite;
        }

        .nav-light-1 {
            top: 15%;
            left: 20%;
        }

        .nav-light-2 {
            top: 15%;
            right: 25%;
        }

        @keyframes nav-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .data-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .data-item {
            text-align: center;
            padding: 0.8rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .data-label {
            color: #0ea5e9;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .data-value {
            color: #10b981;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .global-ports-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .global-ports-panel.minimized {
            height: 60px;
            overflow: hidden;
        }

        .global-ports-panel.expanded {
            padding: 1.5rem;
        }

        .global-panel-header {
            color: #8b5cf6;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 12px 12px 0 0;
            transition: background 0.3s ease;
        }

        .global-panel-header:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .global-expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .global-ports-panel.expanded .global-expand-icon {
            transform: rotate(180deg);
        }

        .global-panel-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .global-ports-panel.minimized .global-panel-content {
            opacity: 0;
            pointer-events: none;
        }

        .port-connection {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .port-connection:last-child {
            border-bottom: none;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .latency-indicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .latency-bar {
            width: 40px;
            height: 4px;
            background: #f1f5f9;
            border-radius: 2px;
            overflow: hidden;
        }

        .latency-fill {
            height: 100%;
            background: #10b981;
            border-radius: 2px;
            animation: latency-pulse 2s ease-in-out infinite;
        }

        @keyframes latency-pulse {
            0%, 100% { width: 70%; }
            50% { width: 95%; }
        }

        .explainable-ai-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .explainable-ai-panel.minimized {
            height: 60px;
            overflow: hidden;
        }

        .explainable-ai-panel.expanded {
            padding: 1.5rem;
        }

        .ai-panel-header {
            color: #f59e0b;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 12px 12px 0 0;
            transition: background 0.3s ease;
        }

        .ai-panel-header:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .explainable-ai-panel.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .ai-panel-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .explainable-ai-panel.minimized .ai-panel-content {
            opacity: 0;
            pointer-events: none;
        }

        .explanation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .explanation-item:last-child {
            border-bottom: none;
        }

        .explanation-content {
            flex: 1;
        }

        .explanation-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .explanation-detail {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.2rem;
        }

        .confidence-indicator {
            width: 60px;
            height: 6px;
            background: #f1f5f9;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-level {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0ea5e9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .uncertainty-indicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: #f59e0b;
            margin-top: 0.3rem;
        }

        .automation-panel {
            background: white;
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .automation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .automation-item:last-child {
            border-bottom: none;
        }

        .automation-content {
            flex: 1;
        }

        .automation-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .automation-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.2rem;
        }

        .auto-generated {
            font-size: 0.7rem;
            color: #059669;
            background: #dcfce7;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            border: 1px solid #bbf7d0;
            font-weight: 500;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            align-items: center;
        }

        .footer-section {
            text-align: center;
        }

        .footer-title {
            color: #0ea5e9;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .footer-value {
            font-size: 1.2rem;
            color: #1e293b;
            font-weight: 600;
        }

        .footer-subtitle {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        .edge-node {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #8b5cf6;
            border-radius: 50%;
            border: 1px solid white;
            animation: edge-compute 3s ease-in-out infinite;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        @keyframes edge-compute {
            0%, 100% { opacity: 0.7; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3); }
            50% { opacity: 1; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.6); }
        }

        .integration-status {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .integration-title {
            color: #8b5cf6;
            font-weight: 600;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
        }

        .integration-list {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.6;
        }

        .terminal-info {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .terminal:hover .terminal-info {
            opacity: 1;
        }

        /* Chat Interface Styles */
        .chat-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 450px;
            height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 280px;
        }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 90%;
            line-height: 1.4;
        }

        .chat-message h1, .chat-message h2, .chat-message h3 {
            margin: 0.5rem 0 0.3rem 0;
            color: #1e293b;
        }

        .chat-message h2 {
            font-size: 1rem;
            font-weight: 600;
            color: #0ea5e9;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.2rem;
        }

        .chat-message h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #059669;
            margin-top: 0.8rem;
        }

        .chat-message ul {
            margin: 0.5rem 0;
            padding-left: 1rem;
        }

        .chat-message li {
            margin-bottom: 0.2rem;
        }

        .chat-message strong {
            color: #1e293b;
            font-weight: 600;
        }

        .chat-message code {
            background: #f1f5f9;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .chat-message pre {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.8rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }

        .chat-message pre code {
            background: none;
            padding: 0;
        }

        .chat-message.user {
            background: #f1f5f9;
            padding: 0.6rem 1rem;
            border-radius: 18px 18px 4px 18px;
            margin-left: auto;
            color: #1e293b;
            font-size: 0.85rem;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 0.6rem 1rem;
            border-radius: 18px 18px 18px 4px;
            margin-right: auto;
            color: #1e293b;
            font-size: 0.85rem;
            border: 1px solid #93c5fd;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            outline: none;
            font-size: 0.85rem;
            background: white;
        }

        .chat-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chat-send-btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.3rem;
            color: #64748b;
            font-size: 0.8rem;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.2rem;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #64748b;
            border-radius: 50%;
            animation: typing-pulse 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes typing-pulse {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        /* Graph overlay styles */
        .graph-overlay {
            position: absolute;
            top: 150px;
            left: 20px;
            width: calc(100% - 40px);
            height: calc(100% - 200px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: none;
            flex-direction: column;
        }

        .graph-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graph-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .graph-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .graph-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 400px;
        }

        /* Alert Animation Styles */
        @keyframes pulse-critical {
            0% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(239, 68, 68, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 12px rgba(0,0,0,0.5), 0 0 0 8px rgba(239, 68, 68, 0.3);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(239, 68, 68, 0);
                transform: scale(1);
            }
        }

        @keyframes pulse-warning {
            0% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(251, 191, 36, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 12px rgba(0,0,0,0.5), 0 0 0 6px rgba(251, 191, 36, 0.3);
                transform: scale(1.03);
            }
            100% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(251, 191, 36, 0);
                transform: scale(1);
            }
        }

        .alert-blink-red {
            animation: pulse-critical 1.5s infinite;
        }

        .alert-blink-yellow {
            animation: pulse-warning 2s infinite;
        }

        /* Integrated Chat Interface Styles */
        .chat-interface-integrated {
            background: #ffffff;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .chat-interface-integrated .chat-messages {
            height: 600px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* Mobile Chat and AI Recommendations */
        @media (max-width: 768px) {
            .chat-interface-integrated {
                padding: 0.75rem;
            }
            
            .chat-interface-integrated .chat-messages {
                height: 400px;
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .chat-interface-integrated .chat-input {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            .chat-interface-integrated .chat-send-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
            
            .ai-recommendations-panel {
                padding: 0.75rem;
            }
            
            .recommendation-item {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .recommendation-title {
                font-size: 0.85rem;
            }
            
            .recommendation-description {
                font-size: 0.8rem;
            }
            
            .rec-action-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .workflow-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            /* Mobile 3D viewpoints buttons */
            .integration-list button {
                padding: 6px 10px;
                font-size: 0.75rem;
                margin: 2px 0;
                width: 100%;
                text-align: left;
            }
        }

        /* Tablet Layout - Intermediate screen sizes */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 250px 1fr 300px;
                grid-template-rows: 70px 1fr 160px;
            }
            
            .header {
                padding: 0 1.5rem;
            }
            
            .sidebar, .control-panel {
                padding: 1.2rem;
            }
            
            .section-title {
                font-size: 0.95rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.8rem;
            }
            
            .status-dashboard {
                padding: 1.2rem;
            }
        }

        .chat-interface-integrated .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-interface-integrated .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #ffffff;
        }

        .chat-interface-integrated .chat-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chat-interface-integrated .chat-send-btn {
            padding: 0.75rem 1rem;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-interface-integrated .chat-send-btn:hover {
            background: #0284c7;
        }

        .chat-interface-integrated .chat-send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Voice Assistant Styles */
        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #0ea5e9;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .voice-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            top: 5px;
            right: 5px;
            display: none;
        }

        .voice-indicator.active {
            display: block;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .voice-toggle-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #f8fafc;
            color: #64748b;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-toggle-btn:hover {
            background: #f1f5f9;
            border-color: #0ea5e9;
        }

        .voice-toggle-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }

        .voice-status {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
            border-top: 1px solid #f1f5f9;
        }

        .voice-status-text {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .voice-status.listening {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #d97706;
        }

        .voice-status.speaking {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #059669;
        }

        .voice-status.error {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            color: #dc2626;
        }

        /* Streaming text and typing indicator styles */
        .chat-message.typing {
            opacity: 0.8;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-style: italic;
            color: #64748b;
        }

        .typing-indicator::after {
            content: '';
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #64748b;
            animation: typing-dot 1.5s infinite;
        }

        @keyframes typing-dot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        .chat-message.ai.streaming {
            border-left: 3px solid #0ea5e9;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                border-left-color: #0ea5e9;
            }
            50% {
                border-left-color: #38bdf8;
            }
        }

        /* AI Recommendations Panel Styles */
        .ai-recommendations-panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .ai-status {
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #dcfce7;
            color: #166534;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #64748b;
            font-family: monospace;
        }

        .active-recommendations {
            min-height: 120px;
            margin-bottom: 1rem;
        }

        .recommendation-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .recommendation-header-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        
        .recommendation-header-item:hover {
            background: rgba(14, 165, 233, 0.05);
            border-radius: 4px;
            padding: 4px;
            margin: -4px;
        }
        
        .expand-arrow {
            font-size: 12px;
            color: #64748b;
            transition: transform 0.2s ease;
        }
        
        .recommendation-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .details-section {
            margin-bottom: 1rem;
        }
        
        .details-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin: 0 0 0.5rem 0;
        }
        
        .action-steps {
            background: #f9fafb;
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid #0ea5e9;
        }
        
        .action-step {
            font-size: 0.8rem;
            color: #374151;
            margin-bottom: 0.4rem;
            padding-left: 0.5rem;
        }
        
        .action-step:last-child {
            margin-bottom: 0;
        }
        
        .impact-risk-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .impact-risk-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        
        .impact-section, .risk-section {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
        }
        
        .impact-section {
            border-left: 3px solid #10b981;
        }
        
        .risk-section {
            border-left: 3px solid #f59e0b;
        }
        
        .impact-section p, .risk-section p {
            font-size: 0.8rem;
            color: #4b5563;
            margin: 0;
            line-height: 1.4;
        }
        
        .recommendation-actions-detailed {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .recommendation-actions-detailed .rec-action-btn {
            flex: 1;
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
        }

        .recommendation-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .recommendation-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .priority-high {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .priority-medium {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .priority-low {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .recommendation-description {
            font-size: 0.85rem;
            color: #475569;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .recommendation-actions {
            display: flex;
            gap: 0.5rem;
        }

        .rec-action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .approve-btn {
            background: #10b981;
            color: white;
        }

        .approve-btn:hover {
            background: #059669;
        }

        .reject-btn {
            background: #ef4444;
            color: white;
        }

        .reject-btn:hover {
            background: #dc2626;
        }

        .defer-btn {
            background: #6b7280;
            color: white;
        }

        .defer-btn:hover {
            background: #4b5563;
        }

        .workflow-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scan-btn {
            background: #0ea5e9;
            color: white;
        }

        .scan-btn:hover {
            background: #0284c7;
        }

        .auto-btn {
            background: #8b5cf6;
            color: white;
        }

        .auto-btn:hover {
            background: #7c3aed;
        }

        .auto-btn.active {
            background: #10b981;
        }

        .auto-btn.active:hover {
            background: #059669;
        }

        .executing-action {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .executing-action::after {
            content: "⚡ EXECUTING...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Status Dashboard Styles */
        .status-dashboard {
            background: #ffffff;
            color: #1e293b;
            padding: 1.5rem;
            margin-top: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.5rem;
            height: 40px;
        }

        .status-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: #ef4444;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .status-timestamp {
            font-size: 0.8rem;
            color: #94a3b8;
            font-family: monospace;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Mobile Status Dashboard */
        @media (max-width: 768px) {
            .status-dashboard {
                padding: 1rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .status-card {
                padding: 0.75rem;
            }
            
            .status-title {
                font-size: 0.8rem;
            }
            
            .status-indicator {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            
            .mini-chart {
                height: 60px;
            }
            
            .status-metrics {
                font-size: 0.75rem;
            }
        }

        .status-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .status-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .status-title {
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            color: #1e293b;
        }

        .status-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .status-indicator:contains("NORMAL"), .status-indicator:contains("GOOD"), .status-indicator:contains("OPTIMAL") {
            background: #10b981;
            color: white;
        }

        .status-indicator:contains("HEAVY"), .status-indicator:contains("HIGH"), .status-indicator:contains("ELEVATED") {
            background: #f59e0b;
            color: white;
        }

        .status-indicator:contains("CRITICAL"), .status-indicator:contains("ALERT") {
            background: #ef4444;
            color: white;
        }

        .mini-chart {
            width: 100%;
            height: 80px;
            margin-bottom: 0.75rem;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .status-metrics {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .status-metrics strong {
            color: #1e293b;
            font-weight: 600;
        }

        /* Critical Alerts Banner */
        .critical-alerts-banner {
            background: #ffffff;
            border-radius: 12px;
            padding: 1rem 2rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: calc(100% + 4rem);
            margin-left: -2rem;
            margin-right: -2rem;
            margin-top: 1rem;
        }

        .alert-ticker {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            white-space: normal;
        }

        .alert-item {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
            flex: 1;
            min-width: 200px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .alert-item.critical {
            background: #ef4444;
            color: white;
        }

        .alert-item.warning {
            background: #f59e0b;
            color: white;
        }

        .alert-item.info {
            background: #0ea5e9;
            color: white;
        }


        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .status-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Traffic Optimization Styles */
        .traffic-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            z-index: 99;
            overflow: hidden;
        }

        .traffic-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }

        .traffic-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .traffic-controls {
            display: flex;
            gap: 0.5rem;
        }

        .traffic-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .traffic-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .traffic-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #d97706;
            font-weight: 600;
        }

        .traffic-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .traffic-view {
            display: none;
            padding: 1rem;
        }

        .traffic-view.active {
            display: block;
        }

        .traffic-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .traffic-metric {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .metric-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
        }

        .metric-desc {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0.3rem 0;
        }

        .metric-status {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .metric-status.good {
            background: #dcfce7;
            color: #059669;
            border: 1px solid #bbf7d0;
        }

        .metric-status.warning {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .metric-status.critical {
            background: #fecaca;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .live-alerts, .route-suggestions, .alerts-list {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .alert-item, .route-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .alert-item:last-child, .route-item:last-child {
            border-bottom: none;
        }

        .alert-content, .route-content {
            flex: 1;
        }

        .alert-title, .route-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .alert-details, .route-details {
            font-size: 0.75rem;
            color: #64748b;
        }

        .alert-time, .route-time {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .alert-severity {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .severity-low { background: #10b981; }
        .severity-medium { background: #f59e0b; }
        .severity-high { background: #ef4444; }
        .severity-critical { background: #dc2626; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .route-action, .alert-action {
            padding: 0.3rem 0.8rem;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .route-action:hover, .alert-action:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
        }

        .alert-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-color: #0ea5e9;
        }

        .route-savings {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.3rem;
        }

        .savings-item {
            background: #ecfdf5;
            border: 1px solid #bbf7d0;
            color: #059669;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Map Traffic Visualization Styles */
        .congestion-zone {
            position: absolute;
            border-radius: 8px;
            border: 2px solid;
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .congestion-zone.critical {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            animation: pulse-red 2s infinite;
        }

        .congestion-zone.high {
            background: rgba(245, 158, 11, 0.3);
            border-color: #f59e0b;
        }

        .congestion-zone.medium {
            background: rgba(234, 179, 8, 0.25);
            border-color: #eab308;
        }

        .congestion-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            text-align: center;
            padding: 0.2rem 0.4rem;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
        }

        @keyframes pulse-red {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .truck-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .truck-marker:hover {
            transform: scale(1.3);
            z-index: 20;
        }

        .truck-marker.moving {
            filter: brightness(1.2) saturate(1.5);
        }

        .truck-marker.delayed {
            filter: hue-rotate(45deg) brightness(0.9);
            animation: bounce 2s infinite;
        }

        .truck-marker.congested {
            filter: hue-rotate(0deg) brightness(0.7) saturate(0.8);
            animation: shake 1.5s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .truck-info {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            text-align: center;
            line-height: 1.2;
        }

        .truck-marker:hover .truck-info {
            opacity: 1;
        }

        .traffic-flow {
            position: absolute;
            border-radius: 4px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .traffic-flow:hover {
            opacity: 1;
        }

        .traffic-flow.good {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .traffic-flow.moderate {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .traffic-flow.slow {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .traffic-flow.congested {
            background: linear-gradient(90deg, #dc2626, #991b1b);
            animation: pulse-flow 3s infinite;
        }

        @keyframes pulse-flow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .port-area {
            position: absolute;
            border: 2px dashed #64748b;
            border-radius: 12px;
            background: rgba(248, 250, 252, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .port-area:hover {
            background: rgba(248, 250, 252, 0.2);
            border-color: #0ea5e9;
        }

        .area-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
            margin-bottom: 0.3rem;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .traffic-status {
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
        }

        .traffic-status.good {
            background: #dcfce7;
            color: #059669;
            border: 1px solid #bbf7d0;
        }

        .traffic-status.moderate {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .traffic-status.high {
            background: #fecaca;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .route-line.suggested {
            animation: dash-flow 3s linear infinite;
        }

        @keyframes dash-flow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 30; }
        }

        .route-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">⚓</div>
                <div>
                    <h1 class="header-title">POLA</h1>
                </div>
            </div>
            <div class="header-info">
                <div class="status-indicator">
                    <div class="status-dot online"></div>
                    <span style="font-size: 0.85rem; color: #64748b;">8 Global Ports</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot online"></div>
                    <span style="font-size: 0.85rem; color: #64748b;">47 Edge Nodes</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot warning"></div>
                    <span style="font-size: 0.85rem; color: #64748b;">3 Alerts</span>
                </div>
                <div id="currentDateTime" style="font-size: 0.85rem; color: #64748b;">Loading...</div>
            </div>
        </div>

        <!-- Sidebar - AI Agents -->
        <div class="sidebar">
            <div class="section-title">🚨 Alerts</div>
            
            <!-- AI Recommendations Panel -->
            <div class="ai-recommendations-panel">
                <div class="recommendation-header">
                    <span class="ai-status" id="aiStatus">🟢 ANALYZING</span>
                    <span class="timestamp" id="lastAnalysis">Last scan: --:--</span>
                </div>
                
                <div class="active-recommendations" id="activeRecommendations">
                    <!-- Recommendations will be populated here -->
                </div>
                
                <div class="workflow-actions">
                    <button class="action-btn scan-btn" onclick="triggerAIScan()">🔍 Trigger AI Scan</button>
                    <button class="action-btn auto-btn" onclick="toggleAutoMode()" id="autoModeBtn">⚡ Enable Auto Mode</button>
                </div>
            </div>

        </div>

        <!-- Main View - Port of LA Map -->
        <div class="main-view">
            <div class="port-map-container" id="mapContainer">
                <!-- Google Maps Integration -->
                <div id="googleMap" class="google-map"></div>
                
                <!-- Map Overlay for Interactive Elements -->
                <div class="map-overlay" id="mapOverlay">
                    <!-- Vessel markers will be added here dynamically -->
                    
                    
                    
                </div>

                <!-- Live Data Fusion Overlay -->
                <div class="data-overlay">
                    <div style="color: #0ea5e9; font-weight: 600; margin-bottom: 1rem; font-size: 0.95rem;">🔄 Live Multi-Source Data Fusion</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Bathymetry</div>
                            <div class="data-value">4D Model Active</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Sedimentation</div>
                            <div class="data-value">Real-time Tracking</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Tidal Data</div>
                            <div class="data-value">+2.3ft Rising</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Environmental</div>
                            <div class="data-value">157 Sensors</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Vessel AIS</div>
                            <div class="data-value">1,247 Tracked</div>
                        </div>
                    </div>
                </div>

                <!-- Global Ports Network -->
                <div class="global-ports-panel minimized" id="globalPanel">
                    <div class="global-panel-header" onclick="toggleGlobalPanel()">
                        <span>🌐 IEEE 2875 Global Network</span>
                        <span class="global-expand-icon">▼</span>
                    </div>
                    <div class="global-panel-content">
                        <div class="port-connection">
                            <span style="color: #1e293b; font-weight: 500;">🇸🇬 Singapore</span>
                            <div class="connection-status">
                                <div class="latency-indicator">
                                    <div class="latency-bar">
                                        <div class="latency-fill"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #10b981;">8ms</span>
                                </div>
                            </div>
                        </div>
                        <div class="port-connection">
                            <span style="color: #1e293b; font-weight: 500;">🇳🇱 Rotterdam</span>
                            <div class="connection-status">
                                <div class="latency-indicator">
                                    <div class="latency-bar">
                                        <div class="latency-fill"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #10b981;">15ms</span>
                                </div>
                            </div>
                        </div>
                        <div class="port-connection">
                            <span style="color: #1e293b; font-weight: 500;">🇨🇳 Shanghai</span>
                            <div class="connection-status">
                                <div class="latency-indicator">
                                    <div class="latency-bar">
                                        <div class="latency-fill"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #f59e0b;">23ms</span>
                                </div>
                            </div>
                        </div>
                        <div class="port-connection">
                            <span style="color: #1e293b; font-weight: 500;">🇬🇧 Felixstowe</span>
                            <div class="connection-status">
                                <div class="latency-indicator">
                                    <div class="latency-bar">
                                        <div class="latency-fill"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #10b981;">12ms</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.75rem; color: #64748b;">
                            Cross-port impact modeling & resilience planning active
                        </div>
                    </div>
                </div>

                <!-- Explainable AI Panel -->
                <div class="explainable-ai-panel minimized" id="aiPanel">
                    <div class="ai-panel-header" onclick="toggleAIPanel()">
                        <span>🔍 Explainable AI Reasoning</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="ai-panel-content">
                        <div class="explanation-item">
                            <div class="explanation-content">
                                <div class="explanation-title">Terminal Capacity Alert</div>
                                <div class="explanation-detail">Pier B: Tidal patterns + Weather forecast + Current load</div>
                            </div>
                            <div class="confidence-indicator">
                                <div class="confidence-level" style="width: 87%; background: #f59e0b;"></div>
                            </div>
                        </div>
                        <div class="explanation-item">
                            <div class="explanation-content">
                                <div class="explanation-title">Route Optimization</div>
                                <div class="explanation-detail">AIS tracking + Bathymetry data + Current conditions</div>
                            </div>
                            <div class="confidence-indicator">
                                <div class="confidence-level" style="width: 94%; background: #10b981;"></div>
                            </div>
                        </div>
                        <div class="explanation-item">
                            <div class="explanation-content">
                                <div class="explanation-title">Environmental Compliance</div>
                                <div class="explanation-detail">Air quality sensors + Water temperature + Noise levels</div>
                            </div>
                            <div class="confidence-indicator">
                                <div class="confidence-level" style="width: 99%; background: #10b981;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.75rem; color: #64748b;">
                            Model uncertainty: ±2.3% variance • Confidence intervals updated real-time
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="section-title">💬 POLA Chat</div>
            
            <!-- Chat Interface Integrated -->
            <div class="chat-interface-integrated">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message ai">
                        Hello! I'm your Port AI Assistant. I continuously monitor operations and can provide recommendations. Enable Auto Mode above for autonomous actions.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <span>AI is analyzing...</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="Click to speak">
                        🎤
                        <div class="voice-indicator" id="voiceIndicator"></div>
                    </button>
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about port operations or click microphone to speak..." maxlength="500">
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">Send</button>
                    <button class="voice-toggle-btn" id="voiceToggleBtn" onclick="toggleVoiceOutput()" title="Toggle voice responses">
                        🔊
                    </button>
                </div>
                <div class="voice-status" id="voiceStatus">
                    <span class="voice-status-text">Voice Assistant Ready</span>
                </div>
            </div>

            <div class="section-title">📊 Real-Time Metrics</div>
            
            <div class="metric-card">
                <div class="metric-value">
                    247
                    <div class="uncertainty-indicator">
                        <span>±3</span>
                        <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></div>
                    </div>
                </div>
                <div class="metric-label">Vessels Tracked (Multi-Source)</div>
            </div>

            <div class="metric-card">
                <div class="metric-value">
                    94.7%
                    <div class="uncertainty-indicator">
                        <span>±1.2%</span>
                        <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
                    </div>
                </div>
                <div class="metric-label">Data Fusion Accuracy</div>
            </div>

            <div class="metric-card">
                <div class="metric-value">
                    <2ms
                    <div class="uncertainty-indicator">
                        <span>Edge</span>
                        <div style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%;"></div>
                    </div>
                </div>
                <div class="metric-label">Inference Latency</div>
            </div>

            <div class="section-title">🤖 Autonomous Operations</div>
            
            <div class="automation-panel">
                <div class="automation-item">
                    <div class="automation-content">
                        <div class="automation-title">Environmental Impact Report</div>
                        <div class="automation-time">Auto-generated at 14:15 PST</div>
                    </div>
                    <div class="auto-generated">AUTO</div>
                </div>
                <div class="automation-item">
                    <div class="automation-content">
                        <div class="automation-title">Risk Assessment Update</div>
                        <div class="automation-time">Auto-generated at 14:20 PST</div>
                    </div>
                    <div class="auto-generated">AUTO</div>
                </div>
                <div class="automation-item">
                    <div class="automation-content">
                        <div class="automation-title">Cross-Port Resilience Plan</div>
                        <div class="automation-time">Updated at 14:18 PST</div>
                    </div>
                    <div class="auto-generated">AUTO</div>
                </div>
            </div>

            <div class="section-title">⚡ Edge Computing Network</div>
            
            <div class="integration-status">
                <div class="integration-title">47 Active Edge Nodes</div>
                <div class="integration-list">
                    🚁 Autonomous Buoys: 12 nodes<br>
                    🏗️ Smart Cranes: 18 nodes<br>
                    ⛵ Pilot Vessels: 8 nodes<br>
                    📡 Fixed Sensors: 9 nodes<br><br>
                    <strong style="color: #10b981;">Sub-2ms inference for critical decisions</strong>
                </div>
            </div>

            <div class="section-title">🏗️ 3D Photorealistic Views</div>
            
            <div class="integration-status">
                <div class="integration-title">Google Earth 3D Models</div>
                <div class="integration-list" style="display: grid; grid-template-columns: 1fr; gap: 4px;">
                    <button onclick="flyTo3DView('vincent_thomas_bridge')" style="padding: 4px 8px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">🌉 Vincent Thomas Bridge</button>
                    <button onclick="flyTo3DView('terminal_island')" style="padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">🏗️ Terminal Island</button>
                    <button onclick="flyTo3DView('pier_400')" style="padding: 4px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">🚢 Pier 400</button>
                    <button onclick="flyTo3DView('main_channel')" style="padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">⚓ Main Channel</button>
                    <button onclick="flyTo3DView('breakwater')" style="padding: 4px 8px; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">🌊 Breakwater</button>
                </div>
            </div>

            <div class="section-title">🚦 Real-Time Traffic & Routing</div>
            
            <div class="integration-status">
                <div class="integration-title">Traffic Monitoring Active</div>
                <div class="integration-list">
                    📍 8 Traffic Monitor Points<br>
                    🚛 Truck Route Optimization<br>
                    👥 Employee Parking Management<br>
                    🗺️ Google Maps Traffic Layer<br>
                    ⏱️ Real-time Delay Estimation<br>
                    🛣️ Alternative Route Suggestions<br><br>
                    <div id="currentTrafficStatus" style="color: #10b981; font-weight: 600;">
                        System Analyzing Traffic...
                    </div>
                </div>
            </div>

            <div class="section-title">🔗 System Integrations</div>
            
            <div class="integration-status">
                <div class="integration-title">23 Data Sources Connected</div>
                <div class="integration-list">
                    ✅ Esri ArcGIS Enterprise<br>
                    ✅ NOAA Weather & Tide APIs<br>
                    ✅ US Coast Guard AIS Network<br>
                    ✅ Port Management Systems<br>
                    ✅ Environmental Sensor Grid<br>
                    ✅ Bathymetric Survey Data<br>
                    ✅ Terminal Operating Systems
                </div>
            </div>
        </div>


        <!-- Real-Time Status Dashboard -->
        <div class="status-dashboard">
            <div class="status-grid">
                <!-- Loading Conditions -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">🏗️</span>
                        <span class="status-title">Loading Conditions</span>
                        <div class="status-indicator" id="loadingStatus">NORMAL</div>
                    </div>
                    <canvas class="mini-chart" id="loadingChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>Active Cranes: <strong id="activeCranes">42/47</strong></span>
                        <span>Avg Load Time: <strong id="avgLoadTime">2.3h</strong></span>
                    </div>
                </div>

                <!-- Vessel Traffic -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">🚢</span>
                        <span class="status-title">Vessel Traffic</span>
                        <div class="status-indicator" id="trafficStatus">HEAVY</div>
                    </div>
                    <canvas class="mini-chart" id="trafficChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>In Channel: <strong id="vesselsInChannel">18</strong></span>
                        <span>Queue Length: <strong id="queueLength">6 vessels</strong></span>
                    </div>
                </div>

                <!-- Environmental -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">🌿</span>
                        <span class="status-title">Environmental</span>
                        <div class="status-indicator" id="envStatus">GOOD</div>
                    </div>
                    <canvas class="mini-chart" id="envChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>Air Quality: <strong id="airQuality">89 ppm</strong></span>
                        <span>Compliance: <strong id="compliance">100%</strong></span>
                    </div>
                </div>

                <!-- Capacity Flow -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">📦</span>
                        <span class="status-title">Capacity Flow</span>
                        <div class="status-indicator" id="capacityStatus">HIGH</div>
                    </div>
                    <canvas class="mini-chart" id="capacityChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>Throughput: <strong id="throughput">89%</strong></span>
                        <span>Bottlenecks: <strong id="bottlenecks">2 active</strong></span>
                    </div>
                </div>

                <!-- Ship Wait Time -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">⏱️</span>
                        <span class="status-title">Ship Wait Time</span>
                        <div class="status-indicator" id="waitStatus">ELEVATED</div>
                    </div>
                    <canvas class="mini-chart" id="waitChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>Avg Wait: <strong id="avgWait">4.2h</strong></span>
                        <span>Max Wait: <strong id="maxWait">8.7h</strong></span>
                    </div>
                </div>

                <!-- Efficiency -->
                <div class="status-card">
                    <div class="status-card-header">
                        <span class="status-icon">⚡</span>
                        <span class="status-title">Efficiency</span>
                        <div class="status-indicator" id="efficiencyStatus">OPTIMAL</div>
                    </div>
                    <canvas class="mini-chart" id="efficiencyChart" width="200" height="80"></canvas>
                    <div class="status-metrics">
                        <span>Overall: <strong id="overallEff">94.2%</strong></span>
                        <span>Target: <strong id="targetEff">90%</strong></span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Graph Overlay -->
        <div class="graph-overlay" id="graphOverlay">
            <div class="graph-header">
                <span id="graphTitle">Data Visualization</span>
                <button class="graph-close" onclick="closeGraph()">×</button>
            </div>
            <div class="graph-content">
                <canvas class="graph-canvas" id="graphCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    
    <script>
        // Create vessel markers with detailed ship icons
        function createVesselMarkers() {
            const mapContainer = document.getElementById('mapContainer');
            const vessels = [
                {id: 1, x: 32, y: 45, name: 'MSC TRUST', type: 'container', confidence: 97.3, ais: true, radar: true},
                {id: 2, x: 55, y: 65, name: 'EVERGREEN GLORY', type: 'container', confidence: 94.1, ais: true, radar: true},
                {id: 3, x: 78, y: 35, name: 'MAERSK SEATTLE', type: 'container', confidence: 98.7, ais: true, radar: false},
                {id: 4, x: 35, y: 50, name: 'CHEVRON VOYAGER', type: 'tanker', confidence: 91.2, ais: false, radar: true},
                {id: 5, x: 65, y: 50, name: 'COSCO SHIPPING', type: 'container', confidence: 96.8, ais: true, radar: true},
                {id: 6, x: 15, y: 85, name: 'APL BANGKOK', type: 'cargo', confidence: 89.4, ais: true, radar: true},
                {id: 7, x: 45, y: 80, name: 'HYUNDAI FAITH', type: 'container', confidence: 93.6, ais: true, radar: false},
                {id: 8, x: 55, y: 40, name: 'VALERO EXPRESS', type: 'tanker', confidence: 95.2, ais: true, radar: true},
                {id: 9, x: 70, y: 70, name: 'YANG MING', type: 'container', confidence: 92.8, ais: true, radar: true},
                {id: 10, x: 40, y: 30, name: 'PACIFIC CARRIER', type: 'cargo', confidence: 88.5, ais: true, radar: false}
            ];

            vessels.forEach(vessel => {
                const marker = document.createElement('div');
                marker.className = 'vessel-marker';
                marker.style.left = vessel.x + '%';
                marker.style.top = vessel.y + '%';
                marker.title = `${vessel.name} - ${vessel.type.toUpperCase()} - Confidence: ${vessel.confidence}%`;
                marker.onclick = () => showAdvancedVesselInfo(vessel);
                
                // Create ship icon based on type
                const shipIcon = document.createElement('div');
                shipIcon.className = `vessel-${vessel.type}`;
                marker.appendChild(shipIcon);
                
                mapContainer.appendChild(marker);
            });
        }

        // Create edge computing nodes positioned around the port
        function createEdgeNodes() {
            const mapContainer = document.getElementById('mapContainer');
            const edgeNodes = [
                {x: 15, y: 25, type: 'buoy'},
                {x: 35, y: 20, type: 'buoy'},
                {x: 55, y: 30, type: 'crane'},
                {x: 70, y: 40, type: 'crane'},
                {x: 85, y: 35, type: 'buoy'},
                {x: 25, y: 65, type: 'pilot'},
                {x: 45, y: 75, type: 'crane'},
                {x: 65, y: 80, type: 'buoy'},
                {x: 80, y: 75, type: 'pilot'},
                {x: 90, y: 60, type: 'sensor'}
            ];

            edgeNodes.forEach(node => {
                const element = document.createElement('div');
                element.className = 'edge-node';
                element.style.left = node.x + '%';
                element.style.top = node.y + '%';
                element.title = `Edge Node: ${node.type.toUpperCase()} - Sub-2ms inference`;
                mapContainer.appendChild(element);
            });
        }

        function showTerminalInfo(terminal, capacity, type) {
            alert(`🏗️ ${terminal}

📊 Current Capacity: ${capacity}
🚢 Terminal Type: ${type}
⚡ Edge Nodes: 3 active
🔄 Data Sources: 8 integrated
📡 Real-time Monitoring: Active

AI Recommendations:
• Optimal berthing time: 15:30 PST
• Expected turnaround: 8.5 hours
• Environmental impact: GREEN`);
        }

        function showAdvancedVesselInfo(vessel) {
            const trackingMethods = [];
            if (vessel.ais) trackingMethods.push('AIS');
            if (vessel.radar) trackingMethods.push('Radar');
            
            alert(`🚢 ${vessel.name}

🎯 Tracking: ${trackingMethods.join(' + ')}
📊 AI Confidence: ${vessel.confidence}%
🚢 Vessel Type: ${vessel.type.toUpperCase()}
⚡ Edge Processing: Active
🌊 Bathymetry: Real-time depth mapping
📍 Position Accuracy: ±2.1m
🔄 Data Fusion: 6 sources integrated

Status: Approaching berth assignment
ETA: 15:45 PST (±5 min uncertainty)
Environmental Compliance: VERIFIED`);
        }

        // Simulate real-time confidence updates
        function updateConfidenceLevels() {
            const confidenceBars = document.querySelectorAll('.confidence-fill');
            confidenceBars.forEach(bar => {
                const currentWidth = parseFloat(bar.style.width) || 90;
                const variation = (Math.random() - 0.5) * 3; // ±1.5% variation
                const newWidth = Math.max(85, Math.min(99, currentWidth + variation));
                bar.style.width = newWidth + '%';
            });
        }

        // Simulate automated report generation
        function simulateAutomation() {
            const automationItems = document.querySelectorAll('.automation-item');
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });

            const randomItem = automationItems[Math.floor(Math.random() * automationItems.length)];
            const timeElement = randomItem.querySelector('.automation-time');
            timeElement.textContent = `Auto-generated at ${timeString} PST`;
            
            // Brief highlight effect
            randomItem.style.background = '#f0fdf4';
            randomItem.style.borderColor = '#10b981';
            setTimeout(() => {
                randomItem.style.background = '';
                randomItem.style.borderColor = '';
            }, 3000);
        }

        // Update vessel positions with realistic maritime movement
        function updateVesselPositions() {
            const markers = document.querySelectorAll('.vessel-marker');
            markers.forEach((marker, index) => {
                const currentLeft = parseFloat(marker.style.left);
                const currentTop = parseFloat(marker.style.top);
                
                // Simulate realistic movement patterns
                const timeOffset = Date.now() / 20000;
                const windEffect = Math.sin(timeOffset + index) * 0.1;
                const currentEffect = Math.cos(timeOffset + index * 1.5) * 0.08;
                
                const newLeft = currentLeft + windEffect;
                const newTop = currentTop + currentEffect;
                
                // Keep vessels within port boundaries
                marker.style.left = Math.max(10, Math.min(90, newLeft)) + '%';
                marker.style.top = Math.max(20, Math.min(85, newTop)) + '%';
            });
        }

        // Update global port synchronization indicators
        function updateGlobalPortLatency() {
            const latencyBars = document.querySelectorAll('.latency-fill');
            const latencyTexts = document.querySelectorAll('.latency-indicator span');
            
            latencyBars.forEach((bar, index) => {
                const baseLatencies = [70, 80, 55, 75]; // Different base values for each port
                const baseLatency = baseLatencies[index] || 70;
                const variation = Math.sin(Date.now() / 4000 + index) * 15;
                const latency = Math.max(40, Math.min(95, baseLatency + variation));
                bar.style.width = latency + '%';
                
                // Update latency text
                if (latencyTexts[index]) {
                    const latencyMs = Math.round(8 + (index * 5) + (Math.random() - 0.5) * 4);
                    latencyTexts[index].textContent = latencyMs + 'ms';
                    
                    // Color based on latency
                    if (latencyMs < 15) {
                        latencyTexts[index].style.color = '#10b981';
                    } else if (latencyMs < 25) {
                        latencyTexts[index].style.color = '#f59e0b';
                    } else {
                        latencyTexts[index].style.color = '#ef4444';
                    }
                }
            });
        }

        // Chat functionality
        let chatHistory = [];
        // Get API key from config.js or fallback
        const GEMINI_API_KEY = window.GEMINI_API_KEY || 'YOUR_GEMINI_API_KEY';
        const GEMINI_MODEL = 'gemini-1.5-pro'; // Using advanced Gemini Pro model
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send to Gemini API
            queryGeminiAPI(message);
        }
        
        function addMessageToChat(message, sender, isInitialGreeting = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'ai' && !isInitialGreeting) {
                // Convert markdown to HTML for AI messages (except initial greeting)
                messageDiv.innerHTML = convertMarkdownToHTML(message);
            } else {
                // Keep user messages and initial greeting as plain text
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function convertMarkdownToHTML(markdown) {
            // Convert markdown to HTML
            let html = markdown
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Bullet points
                .replace(/^[•\-\*]\s+(.*$)/gm, '<li>$1</li>')
                // Wrap consecutive list items in ul tags
                .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // Wrap in paragraphs
                .replace(/^(?!<[hul])/gm, '<p>')
                .replace(/(?<!>)$/gm, '</p>')
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<[hul])/g, '$1')
                .replace(/(<\/[hul]>)<\/p>/g, '$1');
            
            return html;
        }
        
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            document.getElementById('chatSendBtn').disabled = true;
        }
        
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('chatSendBtn').disabled = false;
        }
        
        async function queryGeminiAPI(userMessage) {
            try {
                // Add user message to chat history for context
                chatHistory.push({ role: 'user', content: userMessage });
                
                const portContext = `
                You are an advanced AI assistant for the Port of Los Angeles Digital Twin Dashboard. You have deep expertise in maritime operations, supply chain logistics, environmental monitoring, predictive analytics, and port management.
                
                CURRENT PORT STATUS:
                - Vessels: 247 tracked (Multi-source AIS + Radar fusion, 94.7% accuracy)
                - Terminals: 6 active
                  * Terminal Island: 85% capacity (Container)
                  * Pier A: 67% capacity (Multi-purpose)
                  * Pier B: 92% capacity (Container) - Near capacity alert
                  * Pier C: 78% capacity (Bulk Cargo)
                  * Pier S: 55% capacity (Automotive)
                  * Pier T: 88% capacity (Container)
                - Infrastructure: 47 edge computing nodes, <2ms inference latency
                - Global Network: 8 connected ports (Singapore 8ms, Rotterdam 15ms, Shanghai 23ms, Felixstowe 12ms)
                - Environmental: 157 active sensors, Air quality 89ppm, Water temp 68.3°F, 100% compliance
                - Tidal: +2.3ft rising tide
                - Data Sources: 23 integrated systems
                - AI Agents: 5 autonomous (Bathymetric 95%, Environmental 92%, Risk 88%, Cross-Port 97%, Edge 91%)
                - Operations: 127 autonomous actions today, zero human intervention required
                
                CAPABILITIES:
                You can provide detailed analysis on:
                - Vessel traffic patterns and predictions
                - Terminal capacity optimization
                - Environmental compliance and monitoring
                - Risk assessment and mitigation
                - Supply chain logistics
                - Predictive maintenance
                - Weather impact analysis
                - Economic impact assessments
                - Regulatory compliance
                - Emergency response protocols
                - Cross-port coordination
                - Technology integration
                
                RESPONSE FOCUS:
                Focus on providing detailed operational insights and recommendations. The dashboard already displays real-time charts and graphs in the footer status panels, so focus on analysis and actionable advice rather than data visualization.
                
                RESPONSE GUIDELINES:
                - Provide comprehensive, actionable insights
                - Use specific data points from the port status
                - Explain the reasoning behind recommendations
                - Consider operational, environmental, and economic factors
                - Be proactive in suggesting optimizations
                - Provide detailed textual analysis with numbers and trends
                - Always contextualize responses within broader port operations
                - Reference the real-time status charts visible in the dashboard footer
                
                User question: ${userMessage}
                `;
                
                if (window.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                    // Enhanced fallback response when API key is not configured
                    setTimeout(() => {
                        hideTypingIndicator();
                        const response = generateAdvancedFallbackResponse(userMessage);
                        addMessageToChat(response, 'ai');
                    }, 2000); // Longer delay to simulate advanced processing
                    return;
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${window.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            ...chatHistory.slice(-10).map(msg => ({ // Include last 10 messages for context
                                parts: [{ text: msg.content }],
                                role: msg.role === 'user' ? 'user' : 'model'
                            })),
                            {
                                parts: [{ text: portContext }],
                                role: 'user'
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        },
                        safetySettings: [
                            {
                                category: 'HARM_CATEGORY_HARASSMENT',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            },
                            {
                                category: 'HARM_CATEGORY_HATE_SPEECH',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            }
                        ]
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.candidates && data.candidates[0]) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: 'assistant', content: aiResponse });
                    addMessageToChat(aiResponse, 'ai');
                } else {
                    addMessageToChat('I apologize, but I\'m experiencing technical difficulties. Please try rephrasing your question or try again in a moment.', 'ai');
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Gemini API Error:', error);
                if (error.message.includes('quota')) {
                    addMessageToChat('I\'ve reached my usage limit for now. Please try again later or contact your administrator about increasing API quotas.', 'ai');
                } else if (error.message.includes('network')) {
                    addMessageToChat('I\'m having network connectivity issues. Please check your internet connection and try again.', 'ai');
                } else {
                    addMessageToChat('I\'m experiencing technical difficulties. Please verify your API configuration and try again.', 'ai');
                }
            }
        }
        
        function generateAdvancedFallbackResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Vessel and Traffic Analysis
            if (message.includes('vessel') || message.includes('ship') || message.includes('traffic')) {
                return `## Vessel Traffic Analysis\n\nCurrently tracking **247 vessels** using advanced multi-source data fusion:\n\n• **AIS tracking:** 94.7% accuracy\n• **Radar correlation:** Real-time positioning\n• **Predictive routing:** 8.5-hour average turnaround\n\n### Traffic Patterns\n• **Peak hours:** 12:00-16:00 PST (156-247 vessels)\n• **Off-peak:** 00:00-08:00 PST (45-78 vessels)\n• **Container vessels:** 68% of traffic\n• **Tankers:** 18% of traffic\n• **Cargo ships:** 14% of traffic\n\n### Recommendations\n• **Optimal arrival window:** 15:30 PST\n• **Expected delays:** <30 minutes for containers\n• **Berth availability:** Terminal Island preferred\n\n*Real-time vessel traffic charts are visible in the dashboard footer status panels.*`;
            }
            
            // Terminal Operations
            else if (message.includes('terminal') || message.includes('capacity') || message.includes('berth')) {
                return `## Terminal Capacity Analysis\n\n### Current Utilization\n• **Pier B:** 92% (Container) - ⚠️ Near capacity\n• **Pier T:** 88% (Container) - High utilization\n• **Terminal Island:** 85% (Container) - Optimal\n• **Pier C:** 78% (Bulk Cargo) - Good availability\n• **Pier A:** 67% (Multi-purpose) - Available\n• **Pier S:** 55% (Automotive) - Low utilization\n\n### Operational Insights\n• **Average dwell time:** 4.2 days\n• **Crane productivity:** 32.5 moves/hour\n• **Peak efficiency:** Terminal Island & Pier A\n\n### Recommendations\n• Redirect container traffic to Terminal Island\n• Schedule maintenance during low periods\n• Optimize Pier S for overflow container handling\n\n*Live capacity flow charts are displayed in the dashboard footer.*`;
            }
            
            // Environmental Monitoring
            else if (message.includes('environment') || message.includes('sensor') || message.includes('air') || message.includes('water') || message.includes('compliance')) {
                return `## Environmental Monitoring Status\n\n### Real-time Metrics (157 sensors)\n• **Air Quality:** 89ppm (Excellent - EPA standard <100ppm)\n• **Water Temperature:** 68.3°F (Optimal range)\n• **Noise Levels:** 45dB average (Compliant)\n• **Wind Speed:** 8.2 knots SW\n• **Visibility:** 10+ nautical miles\n\n### Compliance Status\n• **EPA Standards:** 100% compliant\n• **CARB Regulations:** Fully compliant\n• **IMO 2020 Sulfur:** All vessels verified\n• **Ballast Water:** 98% treatment compliance\n\n### Environmental Impact\n• **CO2 reduction:** 15% vs. baseline\n• **Automated emissions reporting:** Active\n• **Shore power utilization:** 78%\n\n*Environmental monitoring charts are continuously updated in the footer dashboard.*`;
            }
            
            // AI and Technology
            else if (message.includes('ai') || message.includes('confidence') || message.includes('model') || message.includes('edge') || message.includes('technology')) {
                return `## AI Systems Performance

### Autonomous Agent Status
• **Bathymetric Fusion AI:** 95% confidence
  - 4D depth modeling active
  - Real-time sedimentation tracking
• **Environmental Compliance:** 92% confidence
  - Automated report generation
  - Predictive compliance monitoring
• **Risk Assessment AI:** 88% confidence
  - Threat detection algorithms
  - Predictive risk modeling
• **Cross-Port Orchestrator:** 97% confidence
  - Global synchronization active
  - 8 ports connected
• **Edge Compute Manager:** 91% confidence
  - 47 nodes active
  - <2ms inference latency

### Technology Integration
• **IEEE 2875 Spatial Web:** Fully deployed
• **5G edge computing:** 96.8% uptime
• **Digital twin accuracy:** 94.7% ±1.2%

*AI confidence levels and system performance are displayed in the left dashboard panel.*`;
            }
            
            // Port Efficiency and Operations
            else if (message.includes('efficiency') || message.includes('performance') || message.includes('port') || message.includes('operation')) {
                return `## Port Operational Efficiency

### Performance Metrics
• **Overall Efficiency:** 96.8%
• **Vessel Processing:** 34% of operations
• **Terminal Operations:** 28% of capacity
• **Data Synchronization:** 22% overhead
• **Edge Computing:** 16% resource allocation

### Daily Statistics
• **Autonomous Actions:** 127 completed
• **Human Interventions:** 0 required
• **Processing Time:** 8.5 hours average
• **Cost per TEU:** $45.30 (15% below target)

### Optimization Opportunities
• Peak hour load balancing
• Predictive maintenance scheduling
• Cross-terminal cargo optimization
• Automated customs clearance

### Economic Impact
• **Revenue:** $2.4M daily throughput
• **Cost savings:** $180K from automation

*Real-time efficiency metrics are tracked in the footer dashboard panels.*`;
            }
            
            // Predictive Analytics
            else if (message.includes('predict') || message.includes('forecast') || message.includes('future') || message.includes('trend')) {
                return `## Predictive Analytics Insights

### Traffic Forecasting
• **Next 24 hours:** 280-320 vessel arrivals
• **Peak period:** 14:00-18:00 PST tomorrow
• **Weather impact:** Minimal (clear conditions)
• **Tide influence:** Optimal morning arrivals

### Capacity Predictions
• **Pier B:** Will reach 95% by 16:00 PST
• **Terminal Island:** Optimal through evening
• **Weekend outlook:** 40% average utilization

### Risk Assessment
• **Congestion probability:** 23% (Low)
• **Weather delays:** <5% chance
• **Equipment availability:** 98% uptime expected

### Recommendations
• Schedule large vessels for morning arrivals
• Implement dynamic pricing for off-peak hours
• Prepare contingency berths at Pier A`;
            }
            
            // Supply Chain and Logistics
            else if (message.includes('supply') || message.includes('chain') || message.includes('logistics') || message.includes('cargo') || message.includes('container')) {
                return `## Supply Chain Analytics

### Container Processing
• **Daily throughput:** 8,450 TEU
• **Average dwell time:** 4.2 days
• **Rail connectivity:** 85% direct
• **Truck turn time:** 45 minutes average

### Cargo Distribution
• **Import containers:** 62%
• **Export containers:** 38%
• **Transshipment:** 12%
• **Empty repositioning:** 23%

### Supply Chain Insights
• **Top trading partners:** China (35%), Japan (18%)
• **Commodity breakdown:** Electronics (28%), Apparel (22%)
• **Seasonal trends:** 15% increase expected Q4

### Optimization Strategies
• Extended gate hours for peak seasons
• Chassis pool optimization
• Inland port connectivity enhancement`;
            }
            
            // Emergency and Safety
            else if (message.includes('emergency') || message.includes('safety') || message.includes('security') || message.includes('incident')) {
                return `## Safety & Security Status

**Current Security Level:** MARSEC Level 1 (Normal)

### Safety Metrics
• **Incident-free days:** 127
• **Safety compliance:** 99.8%
• **Emergency response time:** <4 minutes
• **Coast Guard coordination:** Active

### Emergency Preparedness
• **Fire suppression:** All systems operational
• **Spill response:** Equipment staged and ready
• **Medical facilities:** On-site clinic staffed
• **Evacuation procedures:** Updated monthly

### Security Measures
• **CCTV coverage:** 100% of critical areas
• **Access control:** Biometric and TWIC verified
• **Perimeter monitoring:** Automated threat detection
• **Cybersecurity:** SOC monitoring 24/7`;
            }
            
            // Weather and Environmental
            else if (message.includes('weather') || message.includes('tide') || message.includes('wind') || message.includes('storm')) {
                return `## Weather & Tidal Conditions

### Current Conditions
• **Wind:** 8.2 knots from SW
• **Visibility:** 10+ nautical miles
• **Wave height:** 1-2 feet
• **Barometric pressure:** 30.15 inches

### Tidal Information
• **Current tide:** +2.3ft (Rising)
• **High tide:** 15:45 PST (+5.2ft)
• **Low tide:** 03:30 PST (-1.1ft)
• **Optimal transit:** 14:00-17:00 PST

### 7-Day Forecast
• Clear conditions through Thursday
• Light Pacific storm Friday-Saturday
• Minimal operational impact expected
• **Tidal range:** 4.8-6.1 feet

### Operational Recommendations
• Schedule deep-draft vessels for high tide
• Prepare for increased arrivals before storm`;
            }
            
            // General port inquiries
            else if (message.includes('status') || message.includes('overview') || message.includes('summary')) {
                return `## Port of Los Angeles Status Overview\n\n### 🚢 Vessel Operations\n• **247 vessels** currently tracked\n• **94.7%** multi-source tracking accuracy\n• **Average turnaround:** 8.5 hours\n\n### 🏗️ Terminal Status\n• **6 terminals** operational\n• **81%** average capacity utilization\n• **Peak efficiency** at Terminal Island\n\n### 🌍 Global Connectivity\n• **8 international ports** connected\n• **12ms** average network latency\n• **IEEE 2875** spatial web active\n\n### 🤖 AI Operations\n• **5 autonomous agents** running\n• **127 automated actions** today\n• **94%** average confidence level\n\n### 🌿 Environmental\n• **100%** regulatory compliance\n• **157 sensors** monitoring\n• **Air quality:** Excellent (89ppm)`;
            }
            
            // Visualization requests
            else if (message.includes('graph') || message.includes('chart') || message.includes('visual') || message.includes('show') || message.includes('display')) {
                return `## Available Visualizations

I can generate several types of data visualizations:

• 📊 **Vessel Traffic Analysis** - Real-time and historical tracking
• 📈 **Terminal Capacity** - Utilization across all terminals
• 🌱 **Environmental Data** - Air quality, water temp, noise levels
• 🤖 **AI Confidence Levels** - Model performance metrics
• ⚡ **Port Efficiency** - Operational breakdown and KPIs

Which visualization would you like to see? I'll provide detailed analysis along with the charts.

*Predictive analytics and trends are reflected in the real-time dashboard charts.*`;
            }
            
            // Default comprehensive response
            else {
                return `## Port AI Assistant - Advanced Capabilities\n\nI'm your comprehensive maritime operations assistant with expertise in:\n\n### 🚢 Vessel & Traffic Management\n• Real-time tracking and predictions\n• Berth optimization and scheduling\n• Route planning and efficiency\n\n### 🏗️ Terminal Operations\n• Capacity planning and utilization\n• Equipment scheduling and maintenance\n• Cargo handling optimization\n\n### 🌍 Supply Chain Analytics\n• Global logistics coordination\n• Predictive demand modeling\n• Risk assessment and mitigation\n\n### 🌿 Environmental Monitoring\n• Compliance tracking and reporting\n• Emissions monitoring and reduction\n• Sustainability initiatives\n\n### 🤖 AI & Technology Integration\n• Edge computing optimization\n• Predictive maintenance\n• Automated decision making\n\nFeel free to ask specific questions about any aspect of port operations, and I'll provide detailed analysis with actionable insights!`;
            }
        }
        
        function showGraph(graphType) {
            console.log('showGraph called with type:', graphType);
            
            const overlay = document.getElementById('graphOverlay');
            const title = document.getElementById('graphTitle');
            const canvas = document.getElementById('graphCanvas');
            
            // Set graph title
            const titles = {
                vessel_traffic: 'Vessel Traffic Analysis',
                terminal_capacity: 'Terminal Capacity Utilization',
                environmental_data: 'Environmental Monitoring',
                confidence_levels: 'AI Model Confidence Levels',
                port_efficiency: 'Port Operational Efficiency'
            };
            
            title.textContent = titles[graphType] || 'Data Visualization';
            overlay.style.display = 'flex';
            
            // Generate graph based on type
            setTimeout(() => {
                drawGraph(canvas, graphType);
            }, 100);
        }
        
        function closeGraph() {
            document.getElementById('graphOverlay').style.display = 'none';
        }
        
        // Test function to manually trigger charts
        function testChart(type) {
            console.log('Testing chart type:', type);
            showGraph(type);
        }
        
        // Make test function available globally for debugging
        window.testChart = testChart;
        
        function drawGraph(canvas, graphType) {
            try {
                const ctx = canvas.getContext('2d');
                
                // Get the parent container dimensions
                const container = canvas.parentElement;
                const width = Math.max(Math.min(container.clientWidth - 20, 800), 400);
                const height = Math.max(Math.min(container.clientHeight - 20, 400), 300);
                
                console.log(`Drawing ${graphType} graph with dimensions: ${width}x${height}`);
                
                // Set canvas dimensions
                canvas.width = width;
                canvas.height = height;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
            
            // Set styles
            ctx.font = '12px Inter, sans-serif';
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            const margin = 60;
            const chartWidth = width - 2 * margin;
            const chartHeight = height - 2 * margin;
            
            console.log('Drawing graph type:', graphType);
            console.log('Graph type length:', graphType.length);
            console.log('Graph type charCodes:', [...graphType].map(c => c.charCodeAt(0)));
            
            if (graphType === 'vessel_traffic') {
                console.log('Drawing vessel traffic graph');
                drawVesselTrafficGraph(ctx, margin, chartWidth, chartHeight);
            } else if (graphType === 'terminal_capacity') {
                console.log('Drawing terminal capacity graph');
                drawTerminalCapacityGraph(ctx, margin, chartWidth, chartHeight);
            } else if (graphType === 'environmental_data') {
                console.log('Drawing environmental data graph');
                drawEnvironmentalGraph(ctx, margin, chartWidth, chartHeight);
            } else if (graphType === 'confidence_levels') {
                console.log('Drawing confidence levels graph');
                drawConfidenceGraph(ctx, margin, chartWidth, chartHeight);
            } else if (graphType === 'port_efficiency') {
                console.log('Drawing port efficiency graph');
                drawEfficiencyGraph(ctx, margin, chartWidth, chartHeight);
            } else {
                console.log('No matching graph type, using fallback');
                // Default fallback graph
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Chart visualization ready', width / 2, height / 2);
            }
            } catch (error) {
                console.error('Error drawing graph:', error);
                // Show error message on canvas
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ef4444';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading chart', canvas.width / 2, canvas.height / 2);
            }
        }
        
        function drawVesselTrafficGraph(ctx, margin, width, height) {
            // Draw axes
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, margin + height);
            ctx.lineTo(margin + width, margin + height);
            ctx.stroke();
            
            // Sample data for last 24 hours
            const hours = ['00', '04', '08', '12', '16', '20', '24'];
            const vessels = [45, 78, 156, 247, 189, 123, 67];
            
            // Draw data points and lines
            ctx.strokeStyle = '#0ea5e9';
            ctx.fillStyle = '#0ea5e9';
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            for (let i = 0; i < vessels.length; i++) {
                const x = margin + (i * width) / (vessels.length - 1);
                const y = margin + height - (vessels[i] / 300) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Draw point
                ctx.fillRect(x - 3, y - 3, 6, 6);
                
                // Draw labels
                ctx.fillStyle = '#64748b';
                ctx.fillText(hours[i], x - 10, margin + height + 20);
                ctx.fillText(vessels[i], x - 10, y - 10);
                ctx.fillStyle = '#0ea5e9';
            }
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Inter, sans-serif';
            ctx.fillText('Vessels Tracked Over Time', margin, margin - 20);
            
            // Rotate and draw Y-axis label
            ctx.save();
            ctx.translate(20, margin + height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Number of Vessels', 0, 0);
            ctx.restore();
        }
        
        function drawTerminalCapacityGraph(ctx, margin, width, height) {
            const terminals = ['Terminal Island', 'Pier A', 'Pier B', 'Pier C', 'Pier S', 'Pier T'];
            const capacities = [85, 67, 92, 78, 55, 88];
            
            const barWidth = width / terminals.length - 20;
            
            for (let i = 0; i < terminals.length; i++) {
                const x = margin + i * (width / terminals.length) + 10;
                const barHeight = (capacities[i] / 100) * height;
                const y = margin + height - barHeight;
                
                // Color based on capacity
                if (capacities[i] > 85) {
                    ctx.fillStyle = '#ef4444';
                } else if (capacities[i] > 70) {
                    ctx.fillStyle = '#f59e0b';
                } else {
                    ctx.fillStyle = '#10b981';
                }
                
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Labels
                ctx.fillStyle = '#64748b';
                ctx.save();
                ctx.translate(x + barWidth / 2, margin + height + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(terminals[i], 0, 0);
                ctx.restore();
                
                // Capacity values
                ctx.fillStyle = '#1e293b';
                ctx.fillText(capacities[i] + '%', x + barWidth / 2 - 10, y - 5);
            }
            
            // Title
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Inter, sans-serif';
            ctx.fillText('Terminal Capacity Utilization', margin, margin - 20);
        }
        
        function drawEnvironmentalGraph(ctx, margin, width, height) {
            // Multi-line graph for different environmental metrics
            const timePoints = 12;
            const airQuality = Array.from({ length: timePoints }, (_, i) => 85 + Math.sin(i * 0.5) * 10);
            const waterTemp = Array.from({ length: timePoints }, (_, i) => 68 + Math.cos(i * 0.3) * 3);
            const noiseLevel = Array.from({ length: timePoints }, (_, i) => 45 + Math.sin(i * 0.7) * 8);
            
            // Draw grid
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = margin + (i * height) / 10;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(margin + width, y);
                ctx.stroke();
            }
            
            // Draw air quality line
            drawLine(ctx, airQuality, margin, width, height, '#ef4444', 'Air Quality (ppm)', 100);
            
            // Draw water temperature line
            drawLine(ctx, waterTemp, margin, width, height, '#0ea5e9', 'Water Temp (°F)', 75);
            
            // Draw noise level line
            drawLine(ctx, noiseLevel, margin, width, height, '#10b981', 'Noise Level (dB)', 60);
            
            // Legend
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(margin, margin - 40, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Air Quality', margin + 20, margin - 32);
            
            ctx.fillStyle = '#0ea5e9';
            ctx.fillRect(margin + 100, margin - 40, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Water Temp', margin + 120, margin - 32);
            
            ctx.fillStyle = '#10b981';
            ctx.fillRect(margin + 200, margin - 40, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Noise Level', margin + 220, margin - 32);
        }
        
        function drawLine(ctx, data, margin, width, height, color, label, maxValue) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < data.length; i++) {
                const x = margin + (i * width) / (data.length - 1);
                const y = margin + height - (data[i] / maxValue) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
        }
        
        function drawConfidenceGraph(ctx, margin, width, height) {
            const agents = ['Bathymetric AI', 'Environmental', 'Risk Assessment', 'Cross-Port', 'Edge Manager'];
            const confidence = [95, 92, 88, 97, 91];
            
            const barWidth = width / agents.length - 20;
            
            for (let i = 0; i < agents.length; i++) {
                const x = margin + i * (width / agents.length) + 10;
                const barHeight = (confidence[i] / 100) * height;
                const y = margin + height - barHeight;
                
                // Gradient based on confidence
                if (confidence[i] > 90) {
                    ctx.fillStyle = '#10b981';
                } else if (confidence[i] > 80) {
                    ctx.fillStyle = '#f59e0b';
                } else {
                    ctx.fillStyle = '#ef4444';
                }
                
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Labels
                ctx.fillStyle = '#64748b';
                ctx.save();
                ctx.translate(x + barWidth / 2, margin + height + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(agents[i], 0, 0);
                ctx.restore();
                
                // Confidence values
                ctx.fillStyle = '#1e293b';
                ctx.fillText(confidence[i] + '%', x + barWidth / 2 - 10, y - 5);
            }
            
            // Title
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Inter, sans-serif';
            ctx.fillText('AI Agent Confidence Levels', margin, margin - 20);
        }
        
        function drawEfficiencyGraph(ctx, margin, width, height) {
            // Pie chart for different efficiency metrics
            const centerX = margin + width / 2;
            const centerY = margin + height / 2;
            const radius = Math.min(width, height) / 3;
            
            const metrics = [
                { label: 'Vessel Processing', value: 34, color: '#0ea5e9' },
                { label: 'Terminal Operations', value: 28, color: '#10b981' },
                { label: 'Data Sync', value: 22, color: '#f59e0b' },
                { label: 'Edge Computing', value: 16, color: '#8b5cf6' }
            ];
            
            let currentAngle = -Math.PI / 2;
            
            metrics.forEach((metric, index) => {
                const sliceAngle = (metric.value / 100) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = metric.color;
                ctx.fill();
                
                // Labels
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#1e293b';
                ctx.fillText(metric.label, labelX - 30, labelY);
                ctx.fillText(metric.value + '%', labelX - 10, labelY + 15);
                
                currentAngle += sliceAngle;
            });
            
            // Title
            ctx.fillStyle = '#1e293b';
            ctx.font = '14px Inter, sans-serif';
            ctx.fillText('Port Efficiency Distribution', centerX - 80, margin - 20);
        }
        
        // Toggle AI Panel functionality
        function toggleAIPanel() {
            const panel = document.getElementById('aiPanel');
            if (panel.classList.contains('minimized')) {
                panel.classList.remove('minimized');
                panel.classList.add('expanded');
            } else {
                panel.classList.remove('expanded');
                panel.classList.add('minimized');
            }
        }
        
        // Toggle Global Panel functionality
        function toggleGlobalPanel() {
            const panel = document.getElementById('globalPanel');
            if (panel.classList.contains('minimized')) {
                panel.classList.remove('minimized');
                panel.classList.add('expanded');
            } else {
                panel.classList.remove('expanded');
                panel.classList.add('minimized');
            }
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
        
        // Google Maps Integration
        let map;
        let vesselMarkers = [];
        let structureLabels = [];
        // Use the same API key as Gemini since Google Cloud provides unified access
        
        // Make initGoogleMap globally accessible for the callback
        window.initGoogleMap = function() {
            console.log('🗺️ Initializing Google Map...');
            
            // Port of Los Angeles coordinates
            const portOfLA = {
                lat: 33.7366,
                lng: -118.2639
            };
            
            // Map options with 3D photorealistic view and Google Earth models
            const mapOptions = {
                zoom: 15,
                center: portOfLA,
                mapTypeId: 'hybrid',  // Hybrid mode shows satellite imagery with labels
                tilt: 45,  // Reduced tilt for better overall port overview
                heading: 90,  // Adjusted heading for optimal port perspective
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: true,
                scaleControl: true,
                streetViewControl: false,
                rotateControl: true,  // Enable rotation for 3D
                fullscreenControl: true,
                // Enable 3D buildings and photorealistic models
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "on" }]
                    }
                ]
            };
            
            // Create map
            if (typeof google !== 'undefined' && google.maps) {
                console.log('✅ Google Maps API available, creating map...');
                try {
                    map = new google.maps.Map(document.getElementById('googleMap'), mapOptions);
                    console.log('✅ Google Map created successfully');
                    
                    // Enable traffic layer for real-time traffic data
                    const trafficLayer = new google.maps.TrafficLayer();
                    trafficLayer.setMap(map);
                    console.log('✅ Real-time traffic layer enabled');
                    
                    // Add terminal markers
                    addTerminalMarkers();
                    console.log('✅ Terminal markers added');
                    
                    // Add vessel markers
                    addVesselMarkersToMap();
                    console.log('✅ Vessel markers added');
                    
                    // Add port boundaries
                    addPortBoundaries();
                    console.log('✅ Port boundaries added');
                    
                    // Initialize traffic monitoring system
                    initTrafficMonitoring();
                    console.log('✅ Traffic monitoring system initialized');
                    
                    // Enable 3D photorealistic models from Google Earth
                    enable3DPhotorealisticModels();
                    console.log('✅ 3D photorealistic models enabled');
                    
                    // Add structure labels
                    // addStructureLabels();
                    // console.log('✅ Structure labels added');
                    
                    // 3D navigation controls removed per user request
                    // add3DNavigationControls();
                    // console.log('✅ 3D navigation controls added');
                    
                    // Add 3D toggle control
                    add3DToggleControl();
                    console.log('✅ 3D toggle control added');
                    
                    // Add alert labels
                    addAlertLabels();
                    console.log('✅ Alert labels added');
                } catch (error) {
                    console.error('❌ Error creating Google Map:', error);
                    createFallbackMap();
                }
            } else {
                console.log('❌ Google Maps API not loaded, using fallback map');
                createFallbackMap();
            }
        }
        
        function addTerminalMarkers() {
            const terminals = [
                // Main Container Terminals - more accurate locations
                { name: 'APM Terminals Pier 400', lat: 33.7156, lng: -118.2720, capacity: '67%', type: 'Container' },
                { name: 'TraPac Terminal', lat: 33.7391, lng: -118.2638, capacity: '92%', type: 'Container' },
                { name: 'Everport Terminal', lat: 33.7348, lng: -118.2708, capacity: '78%', type: 'Container' },
                { name: 'West Basin Container Terminal', lat: 33.7425, lng: -118.2580, capacity: '85%', type: 'Container' },
                { name: 'Yang Ming Terminal', lat: 33.7382, lng: -118.2595, capacity: '73%', type: 'Container' },
                { name: 'Yusen Terminals (YTI)', lat: 33.7405, lng: -118.2565, capacity: '81%', type: 'Container' },
                
                // Specialized Terminals
                { name: 'Toyota Logistics Services', lat: 33.7401, lng: -118.2542, capacity: '55%', type: 'Automotive' },
                { name: 'World Cruise Center', lat: 33.7445, lng: -118.2650, capacity: '88%', type: 'Passenger' },
                { name: 'Exxon Mobil Marine Terminal', lat: 33.7265, lng: -118.2580, capacity: '62%', type: 'Liquid Bulk' },
                { name: 'Wilmington Marine Terminal', lat: 33.7845, lng: -118.2695, capacity: '45%', type: 'Dry Bulk' },
                
                // Additional Facilities
                { name: 'Fenix Marine Services', lat: 33.7365, lng: -118.2655, capacity: '89%', type: 'Container' },
                { name: 'Pacific Container Terminal', lat: 33.7415, lng: -118.2535, capacity: '76%', type: 'Container' }
            ];
            
            terminals.forEach(terminal => {
                // Different icons for different terminal types
                let terminalIcon;
                const capacityNum = parseInt(terminal.capacity.replace('%', ''));
                
                if (terminal.type === 'Container') {
                    terminalIcon = {
                        path: 'M 0,0 L 12,0 L 12,8 L 0,8 Z',
                        scale: 1.2,
                        fillColor: capacityNum > 85 ? '#ef4444' : capacityNum > 75 ? '#f59e0b' : '#10b981',
                        fillOpacity: 0.9,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    };
                } else if (terminal.type === 'Automotive') {
                    terminalIcon = {
                        path: 'M 0,4 L 2,0 L 10,0 L 12,4 L 10,8 L 2,8 Z',
                        scale: 1.0,
                        fillColor: '#8b5cf6',
                        fillOpacity: 0.9,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    };
                } else {
                    terminalIcon = {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: capacityNum > 85 ? '#ef4444' : '#0ea5e9',
                        fillOpacity: 0.8,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    };
                }
                
                const marker = new google.maps.Marker({
                    position: { lat: terminal.lat, lng: terminal.lng },
                    map: map,
                    title: `${terminal.name} - ${terminal.capacity} - ${terminal.type}`,
                    icon: terminalIcon
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="font-family: Inter, sans-serif; padding: 8px;">
                            <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 14px;">${terminal.name}</h3>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Capacity:</strong> ${terminal.capacity}</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Type:</strong> ${terminal.type}</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Status:</strong> ${terminal.capacity.replace('%', '') > 85 ? 'Near Capacity' : 'Available'}</p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });
        }
        
        function addVesselMarkersToMap() {
            // Clear existing markers
            vesselMarkers.forEach(marker => marker.setMap(null));
            vesselMarkers = [];
            
            const vessels = [
                // Container Ships - positioned at berths and anchorage areas
                { name: 'MSC TRUST', lat: 33.7390, lng: -118.2480, type: 'container', length: 400, beam: 59 },
                { name: 'EVERGREEN GLORY', lat: 33.7355, lng: -118.2515, type: 'container', length: 366, beam: 51 },
                { name: 'MAERSK SEATTLE', lat: 33.7345, lng: -118.2490, type: 'container', length: 347, beam: 45 },
                { name: 'COSCO SHIPPING', lat: 33.7375, lng: -118.2520, type: 'container', length: 380, beam: 54 },
                { name: 'HYUNDAI FAITH', lat: 33.7365, lng: -118.2505, type: 'container', length: 335, beam: 43 },
                { name: 'YANG MING', lat: 33.7330, lng: -118.2485, type: 'container', length: 321, beam: 42 },
                { name: 'HAPAG LLOYD', lat: 33.7320, lng: -118.2475, type: 'container', length: 390, beam: 56 },
                { name: 'ONE OLYMPUS', lat: 33.7310, lng: -118.2495, type: 'container', length: 400, beam: 58 },
                
                // Ships - positioned in channels and anchorage areas (in water)
                { name: 'CHEVRON VOYAGER', lat: 33.7250, lng: -118.2380, type: 'tanker', length: 274, beam: 48 },
                { name: 'VALERO EXPRESS', lat: 33.7200, lng: -118.2360, type: 'tanker', length: 228, beam: 32 },
                { name: 'SHELL NAVIGATOR', lat: 33.7180, lng: -118.2350, type: 'tanker', length: 250, beam: 44 },
                { name: 'APL BANGKOK', lat: 33.7220, lng: -118.2460, type: 'cargo', length: 210, beam: 30 },
                { name: 'PACIFIC CARRIER', lat: 33.7240, lng: -118.2435, type: 'cargo', length: 185, beam: 28 },
                { name: 'PACIFIC UNITY', lat: 33.7200, lng: -118.2445, type: 'cargo', length: 195, beam: 32 },
                { name: 'LIBERTY STAR', lat: 33.7180, lng: -118.2425, type: 'bulk', length: 225, beam: 38 },
                { name: 'OCEAN SPIRIT', lat: 33.7160, lng: -118.2415, type: 'bulk', length: 200, beam: 35 }
            ];
            
            vessels.forEach(vessel => {
                let vesselIcon;
                
                if (vessel.type === 'container') {
                    // Container ships represented as rectangles (containers on deck)
                    vesselIcon = {
                        path: 'M 0,0 L 30,0 L 30,12 L 0,12 Z',
                        scale: 0.6,
                        fillColor: '#0ea5e9',
                        fillOpacity: 0.9,
                        strokeColor: '#1e40af',
                        strokeWeight: 2,
                        rotation: Math.random() * 360
                    };
                } else {
                    // Actual ships represented with ship-like shapes
                    let color = '#10b981'; // default cargo
                    if (vessel.type === 'tanker') color = '#f59e0b';
                    else if (vessel.type === 'bulk') color = '#8b5cf6';
                    
                    vesselIcon = {
                        path: 'M 0,6 L 4,0 L 28,0 L 32,6 L 28,12 L 4,12 Z',
                        scale: 0.5,
                        fillColor: color,
                        fillOpacity: 0.8,
                        strokeColor: '#ffffff',
                        strokeWeight: 1,
                        rotation: Math.random() * 360
                    };
                }
                
                const marker = new google.maps.Marker({
                    position: { lat: vessel.lat, lng: vessel.lng },
                    map: map,
                    title: `${vessel.name} - ${vessel.type.toUpperCase()}`,
                    icon: vesselIcon
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="font-family: Inter, sans-serif; padding: 8px;">
                            <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 14px;">${vessel.name}</h3>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Type:</strong> ${vessel.type.toUpperCase()}</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Length:</strong> ${vessel.length}m</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Beam:</strong> ${vessel.beam}m</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Tracking:</strong> AIS + Radar</p>
                            <p style="margin: 4px 0; font-size: 12px;"><strong>Confidence:</strong> ${Math.floor(88 + Math.random() * 10)}%</p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                vesselMarkers.push(marker);
            });
        }
        
        function addPortBoundaries() {
            // Port of LA boundary polygon
            const portBoundary = [
                { lat: 33.7567, lng: -118.2434 },
                { lat: 33.7567, lng: -118.2823 },
                { lat: 33.7234, lng: -118.2823 },
                { lat: 33.7234, lng: -118.2434 }
            ];
            
            const portPolygon = new google.maps.Polygon({
                paths: portBoundary,
                strokeColor: '#0ea5e9',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#0ea5e9',
                fillOpacity: 0.1
            });
            
            portPolygon.setMap(map);
        }
        
        function addStructureLabels() {
            const structures = [
                // Major Infrastructure (no pier labels - using satellite map defaults)
                { name: '🌉 Vincent Thomas Bridge', lat: 33.7474, lng: -118.2736, type: 'bridge' },
                { name: '🚢 Main Channel', lat: 33.7250, lng: -118.2400, type: 'channel' },
                { name: '⚓ Anchorage Area', lat: 33.7100, lng: -118.2300, type: 'anchorage' },
                
                // Breakwaters & Navigation
                { name: '🌊 San Pedro Breakwater', lat: 33.7050, lng: -118.2250, type: 'breakwater' },
                { name: '🌊 Long Beach Breakwater', lat: 33.7200, lng: -118.2100, type: 'breakwater' },
                { name: '🗼 Angels Gate Lighthouse', lat: 33.7075, lng: -118.2487, type: 'lighthouse' },
                
                // Transportation
                { name: '🚂 Rail Yard', lat: 33.7500, lng: -118.2750, type: 'rail' }
            ];
            
            structures.forEach(structure => {
                // Create custom label marker
                const labelIcon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 0,
                    fillOpacity: 0,
                    strokeOpacity: 0
                };
                
                const marker = new google.maps.Marker({
                    position: { lat: structure.lat, lng: structure.lng },
                    map: map,
                    icon: labelIcon,
                    title: structure.name
                });
                
                // Create custom label overlay
                const labelDiv = document.createElement('div');
                labelDiv.style.cssText = `
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: 600;
                    white-space: nowrap;
                    pointer-events: none;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                labelDiv.textContent = structure.name;
                
                // Create info window with custom content
                const infoWindow = new google.maps.InfoWindow({
                    content: labelDiv,
                    disableAutoPan: true,
                    pixelOffset: new google.maps.Size(0, -10)
                });
                
                // Show label always (persistent)
                infoWindow.open(map, marker);
                
                structureLabels.push({ marker, infoWindow });
            });
        }
        
        function add3DToggleControl() {
            // Create custom control for 3D toggle
            const toggle3DControlDiv = document.createElement('div');
            
            // Set CSS for the control border
            const toggle3DControl = document.createElement('div');
            toggle3DControl.style.backgroundColor = '#fff';
            toggle3DControl.style.border = '2px solid #fff';
            toggle3DControl.style.borderRadius = '3px';
            toggle3DControl.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
            toggle3DControl.style.cursor = 'pointer';
            toggle3DControl.style.marginTop = '8px';
            toggle3DControl.style.marginRight = '10px';
            toggle3DControl.style.textAlign = 'center';
            toggle3DControl.title = 'Toggle 3D View';
            toggle3DControlDiv.appendChild(toggle3DControl);
            
            // Set CSS for the control interior
            const toggle3DText = document.createElement('div');
            toggle3DText.style.color = 'rgb(25,25,25)';
            toggle3DText.style.fontFamily = 'Roboto,Arial,sans-serif';
            toggle3DText.style.fontSize = '16px';
            toggle3DText.style.lineHeight = '38px';
            toggle3DText.style.paddingLeft = '5px';
            toggle3DText.style.paddingRight = '5px';
            toggle3DText.innerHTML = '🌐 3D';
            toggle3DControl.appendChild(toggle3DText);
            
            let is3D = true;
            
            // Setup the click event listener
            toggle3DControl.addEventListener('click', () => {
                if (is3D) {
                    // Switch to 2D view
                    map.setTilt(0);
                    map.setHeading(0);
                    toggle3DText.innerHTML = '🗺️ 2D';
                    is3D = false;
                } else {
                    // Switch to 3D view
                    map.setTilt(45);
                    map.setHeading(90);
                    toggle3DText.innerHTML = '🌐 3D';
                    is3D = true;
                }
            });
            
            // Add the control to the map
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(toggle3DControlDiv);
        }
        
        function addAlertLabels() {
            const alerts = [
                // Critical Red Alerts
                {
                    name: 'PIER B - 97% CAPACITY',
                    lat: 33.7420, lng: -118.2620,
                    level: 'critical',
                    description: 'Container terminal at maximum capacity. Immediate attention required.',
                    action: 'Redirect incoming vessels to Pier A or C'
                },
                {
                    name: 'TRAFFIC CONGESTION',
                    lat: 33.7280, lng: -118.2450,
                    level: 'critical',
                    description: 'Heavy vessel traffic in main channel. Delays expected.',
                    action: 'Implement traffic control measures'
                },
                {
                    name: 'CRANE MALFUNCTION',
                    lat: 33.7156, lng: -118.2720,
                    level: 'critical',
                    description: 'Pier 400 Crane #3 offline. Reduced loading capacity.',
                    action: 'Maintenance crew dispatched. ETA: 2 hours'
                },
                
                // Warning Yellow Alerts
                {
                    name: 'HIGH TIDE WARNING',
                    lat: 33.7200, lng: -118.2350,
                    level: 'warning',
                    description: 'Tide level: +3.2ft. Monitor smaller vessels.',
                    action: 'Increase dock line monitoring'
                },
                {
                    name: 'WEATHER ADVISORY',
                    lat: 33.7100, lng: -118.2300,
                    level: 'warning',
                    description: 'Wind gusts 25+ knots. Anchorage area affected.',
                    action: 'Suspend small craft operations'
                },
                {
                    name: 'CONTAINER BACKUP',
                    lat: 33.7380, lng: -118.2570,
                    level: 'warning',
                    description: 'Pier C yard utilization at 89%. Approaching limit.',
                    action: 'Accelerate outbound rail operations'
                },
                {
                    name: 'TRUCK QUEUE DELAY',
                    lat: 33.7450, lng: -118.2700,
                    level: 'warning',
                    description: 'Gate processing time: 45+ minutes. Queue building.',
                    action: 'Open additional inspection lanes'
                },
                {
                    name: 'VESSEL DELAY',
                    lat: 33.7320, lng: -118.2400,
                    level: 'warning',
                    description: 'MSC TRUST delayed 3 hours. Schedule adjustment needed.',
                    action: 'Notify cargo owners and adjust berth allocation'
                },
                {
                    name: 'FUEL SPILL RISK',
                    lat: 33.7265, lng: -118.2580,
                    level: 'warning',
                    description: 'Minor leak detected at liquid bulk terminal.',
                    action: 'Environmental team monitoring'
                }
            ];
            
            alerts.forEach(alert => {
                // Determine colors based on alert level
                let fillColor, strokeColor;
                
                if (alert.level === 'critical') {
                    fillColor = '#dc2626'; // Red
                    strokeColor = '#991b1b'; // Dark red
                } else {
                    fillColor = '#f59e0b'; // Yellow
                    strokeColor = '#d97706'; // Dark yellow
                }
                
                // Create flashing circle alert marker
                const alertIcon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: fillColor,
                    fillOpacity: 0.8,
                    strokeColor: strokeColor,
                    strokeWeight: 2,
                    strokeOpacity: 1
                };
                
                const marker = new google.maps.Marker({
                    position: { lat: alert.lat, lng: alert.lng },
                    map: map,
                    icon: alertIcon,
                    title: alert.name,
                    zIndex: 1000 // Ensure alerts appear above other markers
                });
                
                // Add blinking animation
                let isVisible = true;
                setInterval(() => {
                    const icon = marker.getIcon();
                    icon.fillOpacity = isVisible ? 0.1 : 0.8;
                    marker.setIcon(icon);
                    isVisible = !isVisible;
                }, 750); // Blink every 750ms
                
                // Create detailed info window for click
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="font-family: Inter, sans-serif; padding: 12px; max-width: 300px;">
                            <h3 style="margin: 0 0 8px 0; color: ${alert.level === 'critical' ? '#dc2626' : '#f59e0b'}; font-size: 14px; font-weight: 700;">
                                ${alert.name}
                            </h3>
                            <div style="margin-bottom: 8px;">
                                <strong>Status:</strong> ${alert.description}
                            </div>
                            <div style="margin-bottom: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                <strong>Action Required:</strong> ${alert.action}
                            </div>
                            <div style="font-size: 11px; color: #6b7280;">
                                Alert Level: <span style="color: ${alert.level === 'critical' ? '#dc2626' : '#f59e0b'}; font-weight: 600; text-transform: uppercase;">${alert.level}</span>
                            </div>
                        </div>
                    `,
                    disableAutoPan: false,
                    pixelOffset: new google.maps.Size(0, -15)
                });
                
                // Click handler for detailed info
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                structureLabels.push({ marker, infoWindow: infoWindow });
            });
        }
        
        function createFallbackMap() {
            // Fallback to original CSS-based map if Google Maps fails
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = `
                <div style="
                    width: 100%; 
                    height: 100%; 
                    background: linear-gradient(180deg, #dbeafe 0%, #bfdbfe 30%, #93c5fd 70%, #60a5fa 100%);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #1e293b;
                    font-family: Inter, sans-serif;
                    text-align: center;
                    padding: 2rem;
                ">
                    <div style="font-size: 24px; font-weight: 600; margin-bottom: 1rem;">
                        🗺️ Port of Los Angeles Digital Twin
                    </div>
                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 1rem; color: #64748b;">
                        Interactive Satellite Map
                    </div>
                    <div style="
                        background: rgba(255, 255, 255, 0.9);
                        padding: 1.5rem;
                        border-radius: 12px;
                        border: 1px solid #e2e8f0;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                        max-width: 450px;
                        text-align: left;
                    ">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 1rem; color: #0ea5e9; text-align: center;">
                            🔑 API Configuration Required
                        </div>
                        <div style="font-size: 13px; line-height: 1.5; color: #475569;">
                            <strong>For Development:</strong><br>
                            • Set <code>GOOGLE_MAPS_API_KEY</code> in ~/.bashrc<br>
                            • Source the file: <code>source ~/.bashrc</code><br>
                            • Serve with Node.js to access env vars<br><br>
                            
                            <strong>For Production:</strong><br>
                            • Set <code>GOOGLE_MAPS_API_KEY</code> in environment<br>
                            • Enable Maps JavaScript API in Google Cloud<br>
                            • Separate from Gemini AI key for better security<br><br>
                            
                            <strong>Current Status:</strong><br>
                            <span style="color: #ef4444;">❌ Google Maps API Key not detected</span>
                        </div>
                    </div>
                    <div style="
                        margin-top: 1.5rem;
                        font-size: 12px;
                        color: #94a3b8;
                        max-width: 400px;
                        line-height: 1.4;
                    ">
                        Once configured, this will show real Port of LA satellite imagery, 
                        interactive terminals, and live vessel tracking.
                    </div>
                </div>
            `;
        }
        
        function updateVesselPositionsOnMap() {
            if (map && vesselMarkers.length > 0 && typeof google !== 'undefined' && google.maps) {
                vesselMarkers.forEach(marker => {
                    if (marker && marker.getPosition) {
                        const currentPos = marker.getPosition();
                        if (currentPos && currentPos.lat && currentPos.lng) {
                            const newLat = currentPos.lat() + (Math.random() - 0.5) * 0.0001;
                            const newLng = currentPos.lng() + (Math.random() - 0.5) * 0.0001;
                            
                            marker.setPosition({ lat: newLat, lng: newLng });
                        }
                    }
                });
            }
        }
        
        // Load Google Maps API
        function loadGoogleMapsAPI() {
            const mapsApiKey = window.GOOGLE_MAPS_API_KEY;
            console.log('🗺️ Checking Google Maps API key:', mapsApiKey?.substring(0, 10) + '...');
            console.log('🔑 Google Maps API key configured:', mapsApiKey !== 'YOUR_GOOGLE_MAPS_API_KEY');
            
            if (mapsApiKey !== 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.log('📡 Loading Google Maps API...');
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${mapsApiKey}&callback=initGoogleMap`;
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.error('❌ Failed to load Google Maps API');
                    console.error('Possible issues:');
                    console.error('1. Maps JavaScript API not enabled in Google Cloud Console');
                    console.error('2. API key restrictions (HTTP referrers, etc.)');
                    console.error('3. Billing not set up for Google Cloud project');
                    console.error('4. API quota exceeded');
                    createFallbackMap();
                };
                script.onload = function() {
                    console.log('✅ Google Maps API script loaded successfully');
                };
                document.head.appendChild(script);
            } else {
                console.log('⚠️ Google Maps API key not configured, using fallback');
                createFallbackMap();
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Load Google Maps
            loadGoogleMapsAPI();
            
            // Start real-time simulation intervals
            setInterval(updateConfidenceLevels, 8000);
            setInterval(simulateAutomation, 20000);
            setInterval(updateVesselPositionsOnMap, 3000);
            setInterval(updateGlobalPortLatency, 2000);
            
            // Update explainable AI confidence indicators
            setInterval(() => {
                const explanationBars = document.querySelectorAll('.explanation-item .confidence-level');
                explanationBars.forEach(bar => {
                    const currentWidth = parseFloat(bar.style.width) || 90;
                    const newWidth = Math.max(75, Math.min(99, currentWidth + (Math.random() - 0.5) * 4));
                    bar.style.width = newWidth + '%';
                    
                    // Update color based on confidence level
                    if (newWidth > 90) {
                        bar.style.background = '#10b981';
                    } else if (newWidth > 80) {
                        bar.style.background = '#f59e0b';
                    } else {
                        bar.style.background = '#ef4444';
                    }
                });
            }, 6000);
        });

        // Real-Time Status Dashboard Functions
        function initStatusDashboard() {
            initMiniCharts();
            updateStatusIndicators();
            
            // Update every 5 seconds
            setInterval(() => {
                updateMiniCharts();
                updateStatusIndicators();
                updateStatusMetrics();
            }, 5000);
        }

        function initMiniCharts() {
            const chartIds = ['loadingChart', 'trafficChart', 'envChart', 'capacityChart', 'waitChart', 'efficiencyChart'];
            
            chartIds.forEach(id => {
                const canvas = document.getElementById(id);
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw initial chart
                drawMiniChart(ctx, canvas.width, canvas.height, id);
            });
        }

        function drawMiniChart(ctx, width, height, chartType) {
            // Generate realistic data points based on port operations patterns
            const points = 24; // 24 hours of data
            const data = [];
            const currentHour = new Date().getHours();
            
            for (let i = 0; i < points; i++) {
                let value;
                const hour = (currentHour - points + i + 24) % 24; // Past 24 hours
                
                switch(chartType) {
                    case 'loadingChart':
                        // Loading peaks during day shift (6am-6pm), lower at night
                        const dayShift = hour >= 6 && hour <= 18;
                        const baseLoad = dayShift ? 75 : 45;
                        const peakHours = hour >= 10 && hour <= 14; // Peak mid-day
                        const peak = peakHours ? 15 : 0;
                        value = baseLoad + peak + (Math.random() - 0.5) * 8;
                        break;
                        
                    case 'trafficChart':
                        // Traffic follows tidal patterns and business hours
                        const tidalEffect = Math.sin((hour / 24) * 2 * Math.PI) * 10;
                        const businessHours = hour >= 7 && hour <= 19;
                        const baseTraffic = businessHours ? 65 : 35;
                        const rushHours = (hour >= 8 && hour <= 10) || (hour >= 16 && hour <= 18);
                        const rush = rushHours ? 20 : 0;
                        value = baseTraffic + tidalEffect + rush + (Math.random() - 0.5) * 12;
                        break;
                        
                    case 'envChart':
                        // Environmental data is stable with gradual changes
                        const dailyCycle = Math.sin((hour / 24) * 2 * Math.PI) * 5;
                        const weatherVariation = Math.sin((hour + i) * 0.1) * 3;
                        value = 87 + dailyCycle + weatherVariation + (Math.random() - 0.5) * 3;
                        break;
                        
                    case 'capacityChart':
                        // Capacity builds up during day, empties evening/night
                        const dayProgress = hour <= 12 ? hour : (24 - hour);
                        const capacityBuild = (dayProgress / 12) * 25;
                        const weekendFactor = new Date().getDay() <= 1 ? 0.7 : 1; // Lower on weekends
                        value = (60 + capacityBuild) * weekendFactor + (Math.random() - 0.5) * 8;
                        break;
                        
                    case 'waitChart':
                        // Wait times spike during peak hours, low at night
                        const peakMorning = hour >= 7 && hour <= 11;
                        const peakAfternoon = hour >= 14 && hour <= 17;
                        const isPeak = peakMorning || peakAfternoon;
                        const baseWait = hour >= 22 || hour <= 5 ? 20 : 40;
                        const peakWait = isPeak ? 30 : 0;
                        const congestionSpike = Math.random() < 0.1 ? 25 : 0; // Random congestion
                        value = baseWait + peakWait + congestionSpike + (Math.random() - 0.5) * 10;
                        break;
                        
                    case 'efficiencyChart':
                        // Efficiency highest during optimal hours, lower during shifts/breaks
                        const optimalHours = (hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16);
                        const shiftChange = hour % 8 === 0; // Shift changes every 8 hours
                        const breakTime = hour % 4 === 0 && hour % 8 !== 0; // Breaks every 4 hours
                        let baseEff = optimalHours ? 94 : 89;
                        if (shiftChange) baseEff -= 8;
                        if (breakTime) baseEff -= 4;
                        if (hour >= 22 || hour <= 6) baseEff -= 5; // Night shift adjustment
                        value = baseEff + (Math.random() - 0.5) * 4;
                        break;
                        
                    default:
                        value = 50 + Math.random() * 40;
                }
                data.push(Math.max(15, Math.min(98, value)));
            }

            // Draw chart background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // Draw grid lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // Draw chart line
            ctx.strokeStyle = chartType.includes('wait') || chartType.includes('traffic') ? '#f59e0b' : '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();

            data.forEach((value, index) => {
                const x = (width / (points - 1)) * index;
                const y = height - (value / 100) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Fill area under curve
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = chartType.includes('wait') || chartType.includes('traffic') ? '#f59e0b' : '#10b981';
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1;
        }

        function updateMiniCharts() {
            const chartIds = ['loadingChart', 'trafficChart', 'envChart', 'capacityChart', 'waitChart', 'efficiencyChart'];
            
            chartIds.forEach(id => {
                const canvas = document.getElementById(id);
                const ctx = canvas.getContext('2d');
                drawMiniChart(ctx, canvas.width, canvas.height, id);
            });
        }

        function updateStatusIndicators() {
            const indicators = [
                { id: 'loadingStatus', statuses: ['NORMAL', 'BUSY', 'OVERLOAD'] },
                { id: 'trafficStatus', statuses: ['LIGHT', 'MODERATE', 'HEAVY', 'CONGESTED'] },
                { id: 'envStatus', statuses: ['EXCELLENT', 'GOOD', 'FAIR'] },
                { id: 'capacityStatus', statuses: ['LOW', 'MODERATE', 'HIGH', 'CRITICAL'] },
                { id: 'waitStatus', statuses: ['NORMAL', 'ELEVATED', 'HIGH', 'CRITICAL'] },
                { id: 'efficiencyStatus', statuses: ['OPTIMAL', 'GOOD', 'FAIR', 'POOR'] }
            ];

            indicators.forEach(indicator => {
                const element = document.getElementById(indicator.id);
                const randomStatus = indicator.statuses[Math.floor(Math.random() * indicator.statuses.length)];
                element.textContent = randomStatus;
                
                // Update colors
                element.className = 'status-indicator';
                if (['NORMAL', 'GOOD', 'EXCELLENT', 'OPTIMAL', 'LIGHT'].includes(randomStatus)) {
                    element.style.background = '#10b981';
                    element.style.color = 'white';
                } else if (['ELEVATED', 'HIGH', 'BUSY', 'MODERATE', 'HEAVY', 'FAIR'].includes(randomStatus)) {
                    element.style.background = '#f59e0b';
                    element.style.color = 'white';
                } else {
                    element.style.background = '#ef4444';
                    element.style.color = 'white';
                }
            });
        }

        function updateStatusMetrics() {
            const currentHour = new Date().getHours();
            const dayOfWeek = new Date().getDay(); // 0 = Sunday, 6 = Saturday
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isDayShift = currentHour >= 6 && currentHour <= 18;
            const isPeakHours = (currentHour >= 8 && currentHour <= 10) || (currentHour >= 16 && currentHour <= 18);
            
            // Active Cranes - more during day shift, fewer on weekends
            const baseCranes = isDayShift ? 42 : 28;
            const weekendReduction = isWeekend ? -8 : 0;
            const activeCranes = Math.max(20, baseCranes + weekendReduction + Math.floor(Math.random() * 5));
            document.getElementById('activeCranes').textContent = `${activeCranes}/47`;
            
            // Loading Time - faster during optimal hours, slower during peak congestion
            const baseLoadTime = isPeakHours ? 3.2 : 2.1;
            const nightPenalty = !isDayShift ? 0.8 : 0;
            const loadTime = baseLoadTime + nightPenalty + (Math.random() - 0.5) * 0.6;
            document.getElementById('avgLoadTime').textContent = `${loadTime.toFixed(1)}h`;
            
            // Vessels in Channel - follows traffic patterns
            const baseVessels = isDayShift ? 18 : 12;
            const peakBonus = isPeakHours ? 6 : 0;
            const vesselsInChannel = baseVessels + peakBonus + Math.floor(Math.random() * 5);
            document.getElementById('vesselsInChannel').textContent = `${vesselsInChannel}`;
            
            // Queue Length - builds up during peak times
            const baseQueue = isPeakHours ? 4 : 1;
            const congestionFactor = Math.random() < 0.15 ? 3 : 0; // 15% chance of congestion
            const queueLength = baseQueue + congestionFactor + Math.floor(Math.random() * 3);
            document.getElementById('queueLength').textContent = `${queueLength} vessels`;
            
            // Air Quality - varies with traffic and weather
            const baseAQ = 87;
            const trafficPenalty = vesselsInChannel > 20 ? -3 : 0;
            const weatherBonus = Math.random() > 0.7 ? 3 : 0; // 30% chance of good weather
            const airQuality = baseAQ + trafficPenalty + weatherBonus + Math.floor(Math.random() * 4);
            document.getElementById('airQuality').textContent = `${Math.max(75, Math.min(95, airQuality))} ppm`;
            
            // Compliance - very stable, occasional minor issues
            const compliance = Math.random() < 0.05 ? 98 : 100; // 5% chance of minor issue
            document.getElementById('compliance').textContent = `${compliance}%`;
            
            // Throughput - correlates with active operations
            const baseThroughput = (activeCranes / 47) * 100;
            const efficiencyFactor = isDayShift ? 1.1 : 0.9;
            const throughput = baseThroughput * efficiencyFactor + (Math.random() - 0.5) * 8;
            document.getElementById('throughput').textContent = `${Math.max(60, Math.min(95, Math.round(throughput)))}%`;
            
            // Bottlenecks - increase during peak times and equipment issues
            let bottlenecks = isPeakHours ? 2 : 0;
            bottlenecks += Math.random() < 0.1 ? 1 : 0; // 10% chance of equipment issue
            bottlenecks += queueLength > 5 ? 1 : 0; // Traffic creates bottlenecks
            document.getElementById('bottlenecks').textContent = `${bottlenecks} active`;
            
            // Wait Times - directly related to queue and bottlenecks
            const baseWait = queueLength * 0.7 + bottlenecks * 0.5;
            const avgWait = Math.max(1.5, baseWait + (Math.random() - 0.5) * 1.0);
            const maxWait = avgWait * (1.8 + Math.random() * 0.4);
            document.getElementById('avgWait').textContent = `${avgWait.toFixed(1)}h`;
            document.getElementById('maxWait').textContent = `${maxWait.toFixed(1)}h`;
            
            // Overall Efficiency - composite of all factors
            let baseEfficiency = 94;
            if (!isDayShift) baseEfficiency -= 4; // Night shift
            if (isWeekend) baseEfficiency -= 2; // Weekend operations
            if (bottlenecks > 0) baseEfficiency -= bottlenecks * 3; // Bottleneck penalty
            if (queueLength > 3) baseEfficiency -= 2; // Queue penalty
            const efficiency = baseEfficiency + (Math.random() - 0.5) * 3;
            document.getElementById('overallEff').textContent = `${Math.max(75, Math.min(98, efficiency.toFixed(1)))}%`;
            document.getElementById('targetEff').textContent = '90%';
        }

        // Initialize status dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initStatusDashboard();
            updateCurrentDateTime();
            
            // Update date/time every second
            setInterval(updateCurrentDateTime, 1000);
        });

        function updateCurrentDateTime() {
            const now = new Date();
            
            // Format the date and time
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Los_Angeles',
                timeZoneName: 'short'
            };
            
            const formattedDateTime = now.toLocaleString('en-US', options);
            document.getElementById('currentDateTime').textContent = formattedDateTime;
        }

        // 3D Models and Photorealistic View System
        let photorealistic3DEnabled = true;
        let currentView3D = {
            tilt: 67.5,
            heading: 135,
            zoom: 17
        };

        function enable3DPhotorealisticModels() {
            if (!map) return;
            
            console.log('🏗️ Enabling Google Earth photorealistic 3D models...');
            
            try {
                // Enable 3D buildings layer (built into Google Maps)
                map.setOptions({
                    styles: [
                        {
                            featureType: "all",
                            elementType: "geometry",
                            stylers: [{ visibility: "on" }]
                        },
                        {
                            featureType: "landscape.man_made",
                            elementType: "geometry.fill",
                            stylers: [{ visibility: "on" }]
                        },
                        {
                            featureType: "poi.business",
                            elementType: "labels",
                            stylers: [{ visibility: "on" }]
                        }
                    ]
                });
                
                // Set optimal viewing angle for 3D port infrastructure
                const portCenter = { lat: 33.7366, lng: -118.2639 };
                map.setCenter(portCenter);
                map.setZoom(15);
                map.setTilt(45);
                map.setHeading(90);
                
                console.log('✅ 3D photorealistic models active');
                
            } catch (error) {
                console.error('❌ Error enabling 3D models:', error);
            }
        }

        function add3DNavigationControls() {
            if (!map) return;
            
            // Create custom 3D navigation control panel
            const controlDiv = document.createElement('div');
            controlDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
            controlDiv.style.border = '1px solid #ccc';
            controlDiv.style.borderRadius = '8px';
            controlDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            controlDiv.style.cursor = 'pointer';
            controlDiv.style.marginBottom = '10px';
            controlDiv.style.marginRight = '10px';
            controlDiv.style.textAlign = 'center';
            controlDiv.style.padding = '8px';
            controlDiv.style.fontFamily = 'Inter, sans-serif';
            controlDiv.style.fontSize = '12px';
            controlDiv.style.minWidth = '120px';
            controlDiv.title = '3D Navigation Controls';
            
            // Create control buttons
            const controls = [
                { label: '🔄 Rotate Left', action: () => rotate3DView(-15) },
                { label: '🔄 Rotate Right', action: () => rotate3DView(15) },
                { label: '⬆️ Tilt Up', action: () => adjustTilt(-10) },
                { label: '⬇️ Tilt Down', action: () => adjustTilt(10) },
                { label: '🎯 Reset View', action: () => reset3DView() },
                { label: '🏗️ Port Overview', action: () => setPortOverview() },
                { label: '🚢 Terminal View', action: () => setTerminalView() }
            ];
            
            controls.forEach((control, index) => {
                const button = document.createElement('div');
                button.innerHTML = control.label;
                button.style.padding = '4px 8px';
                button.style.margin = '2px 0';
                button.style.backgroundColor = '#f8fafc';
                button.style.border = '1px solid #e2e8f0';
                button.style.borderRadius = '4px';
                button.style.cursor = 'pointer';
                button.style.fontSize = '11px';
                button.style.fontWeight = '500';
                
                button.addEventListener('mouseover', () => {
                    button.style.backgroundColor = '#0ea5e9';
                    button.style.color = 'white';
                });
                
                button.addEventListener('mouseout', () => {
                    button.style.backgroundColor = '#f8fafc';
                    button.style.color = 'black';
                });
                
                button.addEventListener('click', control.action);
                controlDiv.appendChild(button);
            });
            
            // Add to map controls
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(controlDiv);
        }

        function rotate3DView(degrees) {
            if (!map) return;
            currentView3D.heading = (currentView3D.heading + degrees) % 360;
            if (currentView3D.heading < 0) currentView3D.heading += 360;
            
            map.setHeading(currentView3D.heading);
            console.log(`🔄 Rotated to heading: ${currentView3D.heading}°`);
        }

        function adjustTilt(degrees) {
            if (!map) return;
            currentView3D.tilt = Math.max(0, Math.min(67.5, currentView3D.tilt + degrees));
            
            map.setTilt(currentView3D.tilt);
            console.log(`⬆️ Adjusted tilt to: ${currentView3D.tilt}°`);
        }

        function reset3DView() {
            if (!map) return;
            
            currentView3D = { tilt: 45, heading: 90, zoom: 15 };
            
            map.setCenter({ lat: 33.7366, lng: -118.2639 });
            map.setZoom(currentView3D.zoom);
            map.setTilt(currentView3D.tilt);
            map.setHeading(currentView3D.heading);
            
            console.log('🎯 Reset to default 3D view');
        }

        function setPortOverview() {
            if (!map) return;
            
            // Wide overview of entire port complex
            map.setCenter({ lat: 33.7366, lng: -118.2639 });
            map.setZoom(15);
            map.setTilt(45);
            map.setHeading(90);
            
            console.log('🏗️ Set to port overview mode');
        }

        function setTerminalView() {
            if (!map) return;
            
            // Close-up view of main container terminals
            map.setCenter({ lat: 33.7445, lng: -118.2534 }); // Terminal Island
            map.setZoom(18);
            map.setTilt(67.5);
            map.setHeading(180);
            
            console.log('🚢 Set to terminal view mode');
        }

        function add3DToggleControl() {
            if (!map) return;
            
            // Create 3D toggle button with mobile-friendly styling
            const toggleDiv = document.createElement('div');
            toggleDiv.style.backgroundColor = photorealistic3DEnabled ? '#10b981' : '#6b7280';
            toggleDiv.style.border = '1px solid #ccc';
            toggleDiv.style.borderRadius = '8px';
            toggleDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            toggleDiv.style.cursor = 'pointer';
            toggleDiv.style.marginBottom = '10px';
            toggleDiv.style.marginRight = '10px';
            toggleDiv.style.textAlign = 'center';
            toggleDiv.style.padding = '12px';
            toggleDiv.style.fontFamily = 'Inter, sans-serif';
            toggleDiv.style.fontSize = '14px';
            toggleDiv.style.fontWeight = '600';
            toggleDiv.style.color = 'white';
            toggleDiv.style.minWidth = '80px';
            toggleDiv.innerHTML = photorealistic3DEnabled ? '🏗️ 3D ON' : '🗺️ 2D';
            toggleDiv.title = 'Toggle 3D photorealistic view';
            
            // Add mobile-friendly touch events
            toggleDiv.style.touchAction = 'manipulation';
            toggleDiv.style.userSelect = 'none';
            
            toggleDiv.addEventListener('click', () => {
                photorealistic3DEnabled = !photorealistic3DEnabled;
                
                if (photorealistic3DEnabled) {
                    // Enable 3D view
                    map.setTilt(67.5);
                    map.setZoom(Math.max(16, map.getZoom()));
                    toggleDiv.innerHTML = '🏗️ 3D ON';
                    toggleDiv.style.backgroundColor = '#10b981';
                    console.log('✅ 3D mode enabled');
                } else {
                    // Switch to 2D view
                    map.setTilt(0);
                    toggleDiv.innerHTML = '🗺️ 2D';
                    toggleDiv.style.backgroundColor = '#6b7280';
                    console.log('🗺️ 2D mode enabled');
                }
            });
            
            // Add to map controls
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(toggleDiv);
        }

        // Preset 3D viewpoints for different areas of the port
        const preset3DViews = {
            'vincent_thomas_bridge': {
                center: { lat: 33.7427, lng: -118.2734 },
                zoom: 16,
                tilt: 67.5,
                heading: 270,
                name: 'Vincent Thomas Bridge'
            },
            'terminal_island': {
                center: { lat: 33.7445, lng: -118.2534 },
                zoom: 17,
                tilt: 60,
                heading: 180,
                name: 'Terminal Island Container Terminals'
            },
            'pier_400': {
                center: { lat: 33.7298, lng: -118.2456 },
                zoom: 16,
                tilt: 67.5,
                heading: 225,
                name: 'Pier 400 - World\'s Largest Container Terminal'
            },
            'main_channel': {
                center: { lat: 33.7366, lng: -118.2639 },
                zoom: 15,
                tilt: 45,
                heading: 90,
                name: 'Main Channel Approach'
            },
            'breakwater': {
                center: { lat: 33.7156, lng: -118.2489 },
                zoom: 14,
                tilt: 30,
                heading: 45,
                name: 'San Pedro Breakwater'
            }
        };

        function flyTo3DView(viewKey) {
            if (!map || !preset3DViews[viewKey]) return;
            
            const view = preset3DViews[viewKey];
            
            console.log(`🚁 Flying to 3D view: ${view.name}`);
            
            // Animate to the new view
            map.panTo(view.center);
            
            setTimeout(() => {
                map.setZoom(view.zoom);
                map.setTilt(view.tilt);
                map.setHeading(view.heading);
            }, 500);
            
            // Update current view tracking
            currentView3D = {
                tilt: view.tilt,
                heading: view.heading,
                zoom: view.zoom
            };
        }

        // Traffic Monitoring and Routing System
        let trafficMonitoringActive = false;
        let currentTrafficConditions = {};
        let routingRecommendations = [];
        let directionsService = null;
        let directionsRenderer = null;

        // Key traffic monitoring points around Port of LA
        const trafficMonitoringPoints = [
            { name: 'I-110 Northbound at Harbor Blvd', lat: 33.7556, lng: -118.2598, type: 'highway', direction: 'inbound' },
            { name: 'I-110 Southbound at Harbor Blvd', lat: 33.7556, lng: -118.2598, type: 'highway', direction: 'outbound' },
            { name: 'SR-47 Vincent Thomas Bridge', lat: 33.7427, lng: -118.2734, type: 'bridge', direction: 'both' },
            { name: 'Terminal Island Freeway East', lat: 33.7366, lng: -118.2489, type: 'terminal_access', direction: 'both' },
            { name: 'Harbor Blvd at PCH', lat: 33.7702, lng: -118.2584, type: 'arterial', direction: 'both' },
            { name: 'Seaside Ave Terminal Access', lat: 33.7421, lng: -118.2456, type: 'terminal_access', direction: 'both' },
            { name: 'Navy Way at Terminal Island', lat: 33.7398, lng: -118.2711, type: 'terminal_access', direction: 'both' },
            { name: 'Wilmington Blvd Connector', lat: 33.7583, lng: -118.2547, type: 'arterial', direction: 'both' }
        ];

        // Employee parking and entry gates
        const employeeAccessPoints = [
            { name: 'Main Gate - Harbor Blvd', lat: 33.7556, lng: -118.2598, capacity: 1200, currentOccupancy: 0 },
            { name: 'Terminal Island Employee Lot A', lat: 33.7445, lng: -118.2534, capacity: 800, currentOccupancy: 0 },
            { name: 'Terminal Island Employee Lot B', lat: 33.7423, lng: -118.2667, capacity: 600, currentOccupancy: 0 },
            { name: 'West Basin Employee Access', lat: 33.7389, lng: -118.2789, capacity: 400, currentOccupancy: 0 },
            { name: 'Pier 400 Employee Parking', lat: 33.7298, lng: -118.2456, capacity: 1000, currentOccupancy: 0 }
        ];

        function initTrafficMonitoring() {
            console.log('🚦 Initializing traffic monitoring system...');
            
            // Initialize Google Directions service for routing
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#0ea5e9',
                    strokeWeight: 6,
                    strokeOpacity: 0.8
                }
            });
            
            // Start traffic monitoring
            trafficMonitoringActive = true;
            analyzeTrafficConditions();
            
            // Monitor traffic every 2 minutes
            setInterval(analyzeTrafficConditions, 120000);
            
            // Update employee access recommendations every 30 seconds
            setInterval(updateEmployeeRoutingRecommendations, 30000);
            
            console.log('✅ Traffic monitoring active');
        }

        function analyzeTrafficConditions() {
            if (!trafficMonitoringActive || !directionsService) return;
            
            console.log('🚦 Analyzing real-time traffic conditions...');
            
            const currentHour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
            const isRushHour = (currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 19);
            const isShiftChange = (currentHour === 6 || currentHour === 14 || currentHour === 22);
            
            // Simulate traffic analysis based on time patterns and Google traffic layer
            trafficMonitoringPoints.forEach(point => {
                let congestionLevel = 'light';
                let estimatedDelay = 0;
                
                if (isWeekday && isRushHour) {
                    congestionLevel = Math.random() > 0.3 ? 'heavy' : 'moderate';
                    estimatedDelay = Math.random() * 15 + 5; // 5-20 minute delays
                } else if (isShiftChange) {
                    congestionLevel = 'moderate';
                    estimatedDelay = Math.random() * 8 + 2; // 2-10 minute delays
                } else if (isWeekday) {
                    congestionLevel = Math.random() > 0.7 ? 'moderate' : 'light';
                    estimatedDelay = Math.random() * 5; // 0-5 minute delays
                } else {
                    congestionLevel = 'light';
                    estimatedDelay = Math.random() * 2; // 0-2 minute delays
                }
                
                currentTrafficConditions[point.name] = {
                    ...point,
                    congestionLevel,
                    estimatedDelay: Math.round(estimatedDelay),
                    lastUpdated: new Date(),
                    alternativeAvailable: congestionLevel === 'heavy'
                };
            });
            
            // Update employee parking occupancy based on shift patterns
            updateEmployeeParkingOccupancy(currentHour, isWeekday, isShiftChange);
            
            // Generate truck routing recommendations
            generateTruckRoutingRecommendations();
            
            console.log('🚦 Traffic analysis complete:', Object.keys(currentTrafficConditions).length, 'monitoring points updated');
            
            // Update traffic status display
            updateTrafficStatusDisplay();
        }
        
        function updateTrafficStatusDisplay() {
            const statusElement = document.getElementById('currentTrafficStatus');
            if (!statusElement) return;
            
            const heavyTrafficCount = Object.values(currentTrafficConditions)
                .filter(point => point.congestionLevel === 'heavy').length;
            const moderateTrafficCount = Object.values(currentTrafficConditions)
                .filter(point => point.congestionLevel === 'moderate').length;
            
            let statusText = '';
            let statusColor = '#10b981'; // green
            
            if (heavyTrafficCount > 0) {
                statusText = `⚠️ ${heavyTrafficCount} Heavy Traffic Points`;
                statusColor = '#ef4444'; // red
            } else if (moderateTrafficCount > 0) {
                statusText = `⚡ ${moderateTrafficCount} Moderate Traffic Points`;
                statusColor = '#f59e0b'; // yellow
            } else {
                statusText = '✅ All Routes Clear';
                statusColor = '#10b981'; // green
            }
            
            statusElement.textContent = statusText;
            statusElement.style.color = statusColor;
        }

        function updateEmployeeParkingOccupancy(currentHour, isWeekday, isShiftChange) {
            employeeAccessPoints.forEach(lot => {
                let occupancyRate = 0.15; // Weekend/night baseline
                
                if (isWeekday) {
                    if (currentHour >= 6 && currentHour <= 18) {
                        // Day shift peak occupancy
                        occupancyRate = 0.75 + (Math.random() * 0.2 - 0.1); // 65-85%
                    } else if (currentHour >= 19 && currentHour <= 5) {
                        // Night shift occupancy
                        occupancyRate = 0.45 + (Math.random() * 0.15 - 0.075); // 37-52%
                    }
                    
                    // Shift change creates temporary high occupancy
                    if (isShiftChange) {
                        occupancyRate = Math.min(0.95, occupancyRate + 0.2);
                    }
                }
                
                lot.currentOccupancy = Math.round(lot.capacity * occupancyRate);
            });
        }

        function generateTruckRoutingRecommendations() {
            routingRecommendations = [];
            
            const heavyTrafficPoints = Object.values(currentTrafficConditions)
                .filter(point => point.congestionLevel === 'heavy')
                .map(point => point.name);
            
            if (heavyTrafficPoints.length > 0) {
                // Recommend alternative routes for inbound trucks
                if (currentTrafficConditions['I-110 Northbound at Harbor Blvd']?.congestionLevel === 'heavy') {
                    routingRecommendations.push({
                        type: 'truck_routing',
                        priority: 'high',
                        title: 'I-110 Alternative Route',
                        description: `Heavy traffic on I-110 Northbound (${currentTrafficConditions['I-110 Northbound at Harbor Blvd'].estimatedDelay} min delay). Recommend SR-47 via Vincent Thomas Bridge.`,
                        route: 'Use SR-47 → Vincent Thomas Bridge → Terminal Island',
                        estimatedTimeSaving: '8-15 minutes',
                        affectedVehicles: 'Inbound trucks from North/East LA'
                    });
                }
                
                // Recommend alternative routes for outbound trucks
                if (currentTrafficConditions['I-110 Southbound at Harbor Blvd']?.congestionLevel === 'heavy') {
                    routingRecommendations.push({
                        type: 'truck_routing',
                        priority: 'high',
                        title: 'Outbound Route Optimization',
                        description: `Heavy congestion on I-110 Southbound (${currentTrafficConditions['I-110 Southbound at Harbor Blvd'].estimatedDelay} min delay). Recommend alternative inland routes.`,
                        route: 'Use Harbor Blvd → I-405 North → I-605 South bypass',
                        estimatedTimeSaving: '12-20 minutes',
                        affectedVehicles: 'Outbound trucks to inland destinations'
                    });
                }
                
                // Bridge congestion recommendations
                if (currentTrafficConditions['SR-47 Vincent Thomas Bridge']?.congestionLevel === 'heavy') {
                    routingRecommendations.push({
                        type: 'truck_routing',
                        priority: 'medium',
                        title: 'Vincent Thomas Bridge Congestion',
                        description: `Bridge experiencing heavy traffic (${currentTrafficConditions['SR-47 Vincent Thomas Bridge'].estimatedDelay} min delay). Recommend scheduling delays or Terminal Island Freeway.`,
                        route: 'Delay departure 20-30 min or use Terminal Island Freeway East',
                        estimatedTimeSaving: '5-12 minutes',
                        affectedVehicles: 'Cross-harbor truck traffic'
                    });
                }
            }
            
            // Generate employee routing recommendations
            generateEmployeeRoutingRecommendations();
        }

        function generateEmployeeRoutingRecommendations() {
            const currentHour = new Date().getHours();
            const isShiftChange = (currentHour === 6 || currentHour === 14 || currentHour === 22);
            
            // Find lots approaching capacity
            const nearCapacityLots = employeeAccessPoints.filter(lot => 
                (lot.currentOccupancy / lot.capacity) > 0.85
            );
            
            // Find available lots with capacity
            const availableLots = employeeAccessPoints.filter(lot => 
                (lot.currentOccupancy / lot.capacity) < 0.7
            );
            
            if (nearCapacityLots.length > 0 && availableLots.length > 0) {
                routingRecommendations.push({
                    type: 'employee_routing',
                    priority: isShiftChange ? 'high' : 'medium',
                    title: 'Employee Parking Redirection',
                    description: `${nearCapacityLots.map(lot => lot.name).join(', ')} approaching capacity. Available spaces at ${availableLots.map(lot => lot.name).join(', ')}.`,
                    route: `Direct employees to: ${availableLots[0].name} (${availableLots[0].capacity - availableLots[0].currentOccupancy} spaces available)`,
                    estimatedTimeSaving: '5-8 minutes parking time',
                    affectedVehicles: `${nearCapacityLots.reduce((sum, lot) => sum + (lot.capacity - lot.currentOccupancy), 0)} employee vehicles`
                });
            }
            
            // Rush hour employee routing
            if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 18)) {
                const trafficHotspots = Object.values(currentTrafficConditions)
                    .filter(point => point.congestionLevel === 'heavy' && point.type === 'arterial')
                    .map(point => point.name);
                
                if (trafficHotspots.length > 0) {
                    routingRecommendations.push({
                        type: 'employee_routing',
                        priority: 'medium',
                        title: 'Employee Rush Hour Routing',
                        description: `Heavy traffic on ${trafficHotspots.join(', ')}. Recommend alternative employee access routes.`,
                        route: 'Use back access roads: Navy Way → Terminal Island Freeway → Employee Lot B',
                        estimatedTimeSaving: '10-15 minutes',
                        affectedVehicles: 'Day/Evening shift employees'
                    });
                }
            }
        }

        function updateEmployeeRoutingRecommendations() {
            if (!trafficMonitoringActive) return;
            
            // Update employee lot occupancy in real-time
            const currentHour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
            const isShiftChange = Math.abs(currentHour - 6) < 0.5 || Math.abs(currentHour - 14) < 0.5 || Math.abs(currentHour - 22) < 0.5;
            
            updateEmployeeParkingOccupancy(currentHour, isWeekday, isShiftChange);
            
            // Regenerate recommendations if needed
            const hasEmployeeRecommendations = routingRecommendations.some(rec => rec.type === 'employee_routing');
            if (!hasEmployeeRecommendations || isShiftChange) {
                generateEmployeeRoutingRecommendations();
            }
        }

        function showTrafficRoute(origin, destination, avoidHighways = false) {
            if (!directionsService || !directionsRenderer) return;
            
            const request = {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: avoidHighways,
                avoidTolls: false,
                optimizeWaypoints: true
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    directionsRenderer.setMap(map);
                    
                    // Show route info
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    console.log(`Route: ${leg.distance.text}, ${leg.duration.text}`);
                    console.log(`Traffic duration: ${leg.duration_in_traffic ? leg.duration_in_traffic.text : 'N/A'}`);
                } else {
                    console.error('Directions request failed:', status);
                }
            });
        }

        // Function to display traffic recommendations in the UI
        function displayTrafficRecommendations() {
            if (routingRecommendations.length === 0) return;
            
            // Add traffic recommendations to the existing recommendation system
            routingRecommendations.forEach(rec => {
                const trafficRecommendation = {
                    id: `traffic_${Date.now()}_${Math.random()}`,
                    title: rec.title,
                    description: `${rec.description}\n\nRecommended Route: ${rec.route}\nTime Savings: ${rec.estimatedTimeSaving}\nAffects: ${rec.affectedVehicles}`,
                    priority: rec.priority,
                    action: () => `Traffic routing updated: ${rec.route}. Estimated time savings: ${rec.estimatedTimeSaving}`,
                    timestamp: new Date(),
                    status: 'pending',
                    type: rec.type
                };
                
                // Add to current recommendations if not already present
                if (!currentRecommendations.some(existing => existing.title === rec.title)) {
                    currentRecommendations.push(trafficRecommendation);
                }
            });
            
            // Sort recommendations by priority
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            currentRecommendations.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            
            // Update display if recommendations panel exists
            if (document.getElementById('activeRecommendations')) {
                displayRecommendations();
            }
        }

        // Agentic AI Workflow System
        let autoMode = false;
        let currentRecommendations = [];
        let aiAnalysisTimer = null;

        // AI Recommendation Templates based on real-time status
        const recommendationTemplates = [
            {
                trigger: (metrics) => metrics.bottlenecks > 2,
                title: "Reduce Terminal Bottlenecks",
                description: "High bottleneck count detected. Deploy additional cranes to Pier B and optimize container routing.",
                priority: "high",
                action: () => "Deploying 3 additional cranes and rerouting 12 containers through Pier A"
            },
            {
                trigger: (metrics) => metrics.queueLength > 5,
                title: "Manage Vessel Queue",
                description: "Extended vessel queue detected. Implement priority scheduling for time-sensitive cargo.",
                priority: "high", 
                action: () => "Prioritizing 4 vessels with perishable cargo and extending pier operating hours",
                steps: [
                    "1. Review vessel queue and identify time-sensitive cargo (perishables, medical supplies, auto parts)",
                    "2. Priority vessels: MSC TRUST (refrigerated containers), EVERGREEN GLORY (automotive parts)",
                    "3. Contact vessel agents to confirm cargo urgency and berth preferences", 
                    "4. Reassign MSC TRUST from standard Queue Position 6 to Priority Position 2",
                    "5. Extend Pier B operating hours by 4 hours to accommodate priority vessels",
                    "6. Notify affected vessels of revised berthing schedule and estimated delays"
                ],
                impact: "Reduces cargo spoilage, meets critical delivery deadlines, improves customer satisfaction",
                risk: "Medium - Extended operations increase labor costs and fatigue"
            },
            {
                trigger: (metrics) => metrics.avgWait > 6,
                title: "Optimize Berth Allocation",
                description: "Average wait times exceeding target. Reallocate vessels to underutilized terminals.",
                priority: "medium",
                action: () => "Reallocating 3 vessels to Terminal Island and adjusting schedules"
            },
            {
                trigger: (metrics) => metrics.airQuality < 82,
                title: "Environmental Compliance Alert",
                description: "Air quality approaching threshold limits. Recommend emission reduction protocols.",
                priority: "medium",
                action: () => "Activating shore power for 6 vessels and reducing diesel crane operations"
            },
            {
                trigger: (metrics) => metrics.efficiency < 85,
                title: "Improve Port Efficiency",
                description: "Overall efficiency below optimal range. Optimize workflow automation systems.",
                priority: "low",
                action: () => "Updating AI routing algorithms and synchronizing crane operations"
            },
            {
                trigger: (metrics) => metrics.throughput < 75,
                title: "Increase Cargo Throughput",
                description: "Throughput below capacity. Scale up terminal operations and extend shift hours.",
                priority: "medium",
                action: () => "Activating standby terminals and extending day shift by 2 hours"
            },
            {
                trigger: (metrics) => {
                    const nearCapacityLots = employeeAccessPoints.filter(lot => 
                        (lot.currentOccupancy / lot.capacity) > 0.9
                    ).length;
                    return nearCapacityLots > 1;
                },
                title: "Employee Parking Crisis",
                description: "Multiple employee parking lots at capacity. Activate overflow parking and shuttle services.",
                priority: "medium",
                action: () => "Opening overflow lots and deploying 3 shuttle buses from remote parking"
            }
        ];

        function triggerAIScan() {
            console.log('🤖 Triggering AI scan...');
            
            // Update AI status
            const aiStatus = document.getElementById('aiStatus');
            const lastAnalysis = document.getElementById('lastAnalysis');
            
            aiStatus.textContent = '🔄 SCANNING';
            aiStatus.style.background = '#f59e0b';
            
            // Simulate analysis time
            setTimeout(() => {
                performAIAnalysis();
                
                aiStatus.textContent = '🟢 COMPLETED';
                aiStatus.style.background = '#10b981';
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastAnalysis.textContent = `Last scan: ${timeStr}`;
            }, 2500);
        }

        function performAIAnalysis() {
            console.log('🔍 Performing AI analysis...');
            
            // Gather current metrics
            const metrics = {
                bottlenecks: parseInt(document.getElementById('bottlenecks').textContent) || 0,
                queueLength: parseInt(document.getElementById('queueLength').textContent.split(' ')[0]) || 0,
                avgWait: parseFloat(document.getElementById('avgWait').textContent) || 0,
                airQuality: parseInt(document.getElementById('airQuality').textContent) || 90,
                efficiency: parseFloat(document.getElementById('overallEff').textContent) || 94,
                throughput: parseInt(document.getElementById('throughput').textContent) || 90
            };
            
            console.log('Current metrics:', metrics);
            
            // Clear existing recommendations
            currentRecommendations = [];
            
            // Generate recommendations based on current conditions
            recommendationTemplates.forEach((template, index) => {
                if (template.trigger(metrics)) {
                    currentRecommendations.push({
                        id: `rec_${Date.now()}_${index}`,
                        ...template,
                        timestamp: new Date(),
                        status: 'pending'
                    });
                }
            });
            
            // Integrate traffic and routing recommendations
            if (trafficMonitoringActive) {
                displayTrafficRecommendations();
            }
            
            // Always show multiple recommendations based on current map alerts
            const alertBasedRecommendations = [
                // Critical Priority - Red Alerts from Map
                {
                    title: "URGENT: Pier B Capacity Crisis",
                    description: "Terminal at 97% capacity. Immediate vessel redirection needed to prevent gridlock.",
                    priority: "high",
                    action: () => "Redirecting MSC TRUST and EVERGREEN GLORY to Pier A. Activating overflow protocols.",
                    steps: [
                        "1. Contact MSC TRUST vessel captain - redirect to Pier A Berth 7",
                        "2. Contact EVERGREEN GLORY - redirect to Pier A Berth 9", 
                        "3. Activate overflow yard at Terminal Island",
                        "4. Deploy 2 additional yard hostlers to Pier A",
                        "5. Notify trucking companies of berth changes",
                        "6. Update vessel scheduling system with new assignments"
                    ],
                    impact: "Prevents terminal gridlock, maintains cargo flow",
                    risk: "Low - Standard overflow protocols"
                },
                {
                    title: "CRITICAL: Traffic Channel Congestion", 
                    description: "Main shipping channel blocked. Deploy tugboats and implement traffic control measures.",
                    priority: "high",
                    action: () => "Dispatching 3 tugboats to clear channel. Rerouting incoming vessels to alternate approaches.",
                    steps: [
                        "1. Deploy tugboat PACIFIC GUARDIAN to assist vessel positioning",
                        "2. Deploy tugboat HARBOR MASTER to clear southern approach", 
                        "3. Deploy tugboat CHANNEL PILOT for traffic coordination",
                        "4. Implement single-file vessel transit through main channel",
                        "5. Route incoming vessels via alternate East Channel approach",
                        "6. Coordinate with Coast Guard for traffic control zone"
                    ],
                    impact: "Restores normal channel flow within 45 minutes",
                    risk: "Medium - Weather dependent operations"
                },
                {
                    title: "URGENT: Pier 400 Crane Failure",
                    description: "Crane #3 offline reducing loading capacity by 30%. Maintenance crew deployed.",
                    priority: "high", 
                    action: () => "Emergency repair initiated. Redistributing container operations to Cranes #1 and #4.",
                    steps: [
                        "1. Emergency shutdown of Crane #3 - safety protocols active",
                        "2. Dispatch certified maintenance team with backup parts",
                        "3. Redistribute MAERSK SEATTLE loading to Crane #1",
                        "4. Redirect COSCO SHIPPING operations to Crane #4",
                        "5. Extend shift hours for operational cranes",
                        "6. Notify vessel operators of revised loading schedule"
                    ],
                    impact: "Maintains 85% loading capacity during repairs",
                    risk: "Low - Established contingency procedures"
                },
                
                // Medium Priority - Yellow Alerts from Map
                {
                    title: "High Tide Advisory Response",
                    description: "Tide level +3.2ft affecting small craft operations. Enhanced monitoring required.",
                    priority: "medium",
                    action: () => "Increasing dock line inspections. Restricting small vessel movements until tide recedes.",
                    steps: [
                        "1. Deploy dock inspectors to all small craft berths",
                        "2. Check and adjust dock lines for tide compensation",
                        "3. Restrict vessels under 100ft from leaving berth",
                        "4. Monitor tide conditions every 15 minutes",
                        "5. Issue advisory to all berthed small vessels",
                        "6. Prepare emergency response boats if needed"
                    ],
                    impact: "Prevents vessel damage from abnormal tide levels",
                    risk: "Low - Standard tidal response procedures"
                },
                {
                    title: "Weather Impact Mitigation",
                    description: "25+ knot winds affecting anchorage. Suspend non-essential operations.",
                    priority: "medium", 
                    action: () => "Implementing weather protocols. Moving vulnerable vessels to protected berths.",
                    steps: [
                        "1. Issue wind advisory to all vessel operators",
                        "2. Suspend small craft and tender operations",
                        "3. Move APL BANGKOK to protected inner berth",
                        "4. Secure all loose equipment on terminals",
                        "5. Deploy additional dock lines for large vessels",
                        "6. Monitor weather conditions hourly"
                    ],
                    impact: "Prevents weather-related incidents and damage",
                    risk: "Medium - Wind conditions may worsen"
                },
                {
                    title: "Container Yard Optimization",
                    description: "Pier C at 89% capacity. Accelerate rail operations to prevent backup.",
                    priority: "medium",
                    action: () => "Prioritizing outbound rail movements. Opening additional yard sections.",
                    steps: [
                        "1. Contact BNSF Railway to expedite next 3 outbound trains",
                        "2. Open overflow yard section C-7 for additional capacity",
                        "3. Deploy 2 additional yard cranes to expedite loading",
                        "4. Prioritize export containers for immediate rail loading",
                        "5. Defer non-critical import container placement",
                        "6. Update yard management system with capacity status"
                    ],
                    impact: "Maintains optimal yard flow, prevents bottlenecks",
                    risk: "Low - Standard capacity management"
                },
                {
                    title: "Gate Processing Delays",
                    description: "Truck queue time exceeding 45 minutes. Open additional inspection lanes.",
                    priority: "medium",
                    action: () => "Activating Lanes 7-9. Deploying additional inspection personnel.",
                    steps: [
                        "1. Open inspection lanes 7, 8, and 9 immediately",
                        "2. Deploy 3 additional CBP officers to new lanes", 
                        "3. Activate backup RFID and scanning equipment",
                        "4. Implement express lane for pre-approved truckers",
                        "5. Send queue status updates to trucking dispatch",
                        "6. Monitor processing times every 10 minutes"
                    ],
                    impact: "Reduces truck wait times to under 20 minutes",
                    risk: "Low - Additional staffing available"
                },
                
                // Low Priority - Proactive Measures  
                {
                    title: "Vessel Schedule Optimization",
                    description: "MSC TRUST 3-hour delay creating schedule cascade. Adjust berth allocations.",
                    priority: "low",
                    action: () => "Rescheduling dependent operations. Notifying cargo stakeholders of delays.",
                    steps: [
                        "1. Reschedule MSC TRUST berth time from 14:00 to 17:00",
                        "2. Adjust YANG MING arrival to accommodate delay",
                        "3. Notify cargo owners and freight forwarders",
                        "4. Update terminal labor shift assignments",
                        "5. Coordinate with rail operators for schedule changes",
                        "6. Send revised ETAs to trucking companies"
                    ],
                    impact: "Minimizes schedule disruption, maintains efficiency",
                    risk: "Low - Routine schedule adjustment"
                },
                {
                    title: "Environmental Monitoring",
                    description: "Minor leak detected at bulk terminal. Environmental team monitoring situation.",
                    priority: "low", 
                    action: () => "Containment protocols active. Monitoring for any expansion of affected area.",
                    steps: [
                        "1. Continue containment boom deployment around affected area",
                        "2. Sample water quality every 2 hours for analysis",
                        "3. Monitor leak source for any increase in flow",
                        "4. Coordinate with Coast Guard environmental response",
                        "5. Document incident for regulatory reporting",
                        "6. Prepare cleanup resources if containment fails"
                    ],
                    impact: "Prevents environmental damage, maintains compliance",
                    risk: "Low - Leak currently contained and stable"
                }
            ];
            
            // Add multiple recommendations to show comprehensive alert coverage
            alertBasedRecommendations.forEach((rec, index) => {
                currentRecommendations.push({
                    id: `rec_${Date.now()}_${index}`,
                    ...rec,
                    timestamp: new Date(),
                    status: 'pending'
                });
            });
            
            // Sort by priority (high -> medium -> low)
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            currentRecommendations.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            
            console.log(`Generated ${currentRecommendations.length} recommendations:`, currentRecommendations);
            
            // Update UI
            displayRecommendations();
            
            // Auto-execute if auto mode is enabled
            if (autoMode) {
                setTimeout(autoExecuteRecommendations, 1500);
            }
        }

        function displayRecommendations() {
            const container = document.getElementById('activeRecommendations');
            
            if (currentRecommendations.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">No active recommendations. All systems optimal.</div>';
                return;
            }
            
            container.innerHTML = currentRecommendations.map(rec => `
                <div class="recommendation-item" id="rec-${rec.id}">
                    <div class="recommendation-header-item" onclick="toggleRecommendationDetails('${rec.id}')">
                        <div class="recommendation-title">${rec.title}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="recommendation-priority priority-${rec.priority}">${rec.priority.toUpperCase()}</div>
                            <span class="expand-arrow" id="arrow-${rec.id}">▶</span>
                        </div>
                    </div>
                    <div class="recommendation-description">${rec.description}</div>
                    
                    <!-- Expandable Details Section -->
                    <div class="recommendation-details" id="details-${rec.id}" style="display: none;">
                        <div class="details-section">
                            <h4>📋 Step-by-Step Actions:</h4>
                            <div class="action-steps">
                                ${rec.steps ? rec.steps.map(step => `<div class="action-step">${step}</div>`).join('') : '<div class="action-step">No detailed steps available</div>'}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="impact-risk-grid">
                                <div class="impact-section">
                                    <h4>✅ Expected Impact:</h4>
                                    <p>${rec.impact || 'Impact assessment in progress...'}</p>
                                </div>
                                <div class="risk-section">
                                    <h4>⚠️ Risk Assessment:</h4>
                                    <p>${rec.risk || 'Risk evaluation pending...'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="recommendation-actions-detailed">
                            <button class="rec-action-btn approve-btn" onclick="approveRecommendation('${rec.id}')">
                                ✓ Approve & Execute
                            </button>
                            <button class="rec-action-btn reject-btn" onclick="rejectRecommendation('${rec.id}')">
                                ✗ Reject
                            </button>
                            <button class="rec-action-btn defer-btn" onclick="deferRecommendation('${rec.id}')">
                                ⏸ Defer for Review
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Actions (shown when collapsed) -->
                    <div class="recommendation-actions" id="quick-actions-${rec.id}">
                        <button class="rec-action-btn approve-btn" onclick="approveRecommendation('${rec.id}')">✓ Approve</button>
                        <button class="rec-action-btn reject-btn" onclick="rejectRecommendation('${rec.id}')">✗ Reject</button>
                        <button class="rec-action-btn defer-btn" onclick="deferRecommendation('${rec.id}')">⏸ Defer</button>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleRecommendationDetails(recId) {
            const detailsElement = document.getElementById(`details-${recId}`);
            const arrowElement = document.getElementById(`arrow-${recId}`);
            const quickActionsElement = document.getElementById(`quick-actions-${recId}`);
            
            if (detailsElement.style.display === 'none') {
                // Expand
                detailsElement.style.display = 'block';
                arrowElement.textContent = '▼';
                quickActionsElement.style.display = 'none';
            } else {
                // Collapse
                detailsElement.style.display = 'none';
                arrowElement.textContent = '▶';
                quickActionsElement.style.display = 'block';
            }
        }

        function approveRecommendation(recId) {
            console.log(`✅ Approving recommendation: ${recId}`);
            
            const recommendation = currentRecommendations.find(rec => rec.id === recId);
            if (!recommendation) return;
            
            recommendation.status = 'approved';
            
            // Execute the action
            executeRecommendation(recommendation);
        }

        function rejectRecommendation(recId) {
            console.log(`❌ Rejecting recommendation: ${recId}`);
            
            const recommendation = currentRecommendations.find(rec => rec.id === recId);
            if (!recommendation) return;
            
            recommendation.status = 'rejected';
            
            // Remove from display
            const element = document.getElementById(`rec-${recId}`);
            if (element) {
                element.style.opacity = '0.5';
                element.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 1rem;">
                        <strong>❌ REJECTED</strong><br>
                        ${recommendation.title}
                    </div>
                `;
                
                setTimeout(() => {
                    currentRecommendations = currentRecommendations.filter(rec => rec.id !== recId);
                    displayRecommendations();
                }, 2000);
            }
        }

        function deferRecommendation(recId) {
            console.log(`⏸ Deferring recommendation: ${recId}`);
            
            const recommendation = currentRecommendations.find(rec => rec.id === recId);
            if (!recommendation) return;
            
            recommendation.status = 'deferred';
            
            // Mark as deferred in UI
            const element = document.getElementById(`rec-${recId}`);
            if (element) {
                element.style.opacity = '0.7';
                element.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 1rem;">
                        <strong>⏸ DEFERRED</strong><br>
                        ${recommendation.title}<br>
                        <small>Will re-analyze in next scan</small>
                    </div>
                `;
                
                setTimeout(() => {
                    currentRecommendations = currentRecommendations.filter(rec => rec.id !== recId);
                    displayRecommendations();
                }, 3000);
            }
        }

        function executeRecommendation(recommendation) {
            console.log(`⚡ Executing recommendation: ${recommendation.title}`);
            
            const element = document.getElementById(`rec-${recommendation.id}`);
            if (element) {
                element.classList.add('executing-action');
                
                // Simulate execution time
                setTimeout(() => {
                    const actionResult = recommendation.action();
                    console.log(`✅ Action completed: ${actionResult}`);
                    
                    element.classList.remove('executing-action');
                    element.innerHTML = `
                        <div style="text-align: center; color: #10b981; padding: 1rem;">
                            <strong>✅ EXECUTED</strong><br>
                            ${recommendation.title}<br>
                            <small>${actionResult}</small>
                        </div>
                    `;
                    
                    // Remove after showing result
                    setTimeout(() => {
                        currentRecommendations = currentRecommendations.filter(rec => rec.id !== recommendation.id);
                        displayRecommendations();
                    }, 4000);
                    
                }, Math.random() * 3000 + 2000); // 2-5 seconds execution time
            }
        }

        function toggleAutoMode() {
            autoMode = !autoMode;
            const btn = document.getElementById('autoModeBtn');
            
            if (autoMode) {
                btn.textContent = '🤖 Auto Mode ON';
                btn.classList.add('active');
                console.log('🤖 Auto mode ENABLED - AI will execute approved actions automatically');
                
                // Start periodic scans in auto mode
                if (aiAnalysisTimer) clearInterval(aiAnalysisTimer);
                aiAnalysisTimer = setInterval(() => {
                    if (currentRecommendations.length === 0) {
                        triggerAIScan();
                    }
                }, 30000); // Scan every 30 seconds when no active recommendations
                
            } else {
                btn.textContent = '⚡ Enable Auto Mode';
                btn.classList.remove('active');
                console.log('👤 Auto mode DISABLED - Human approval required');
                
                // Stop periodic scans
                if (aiAnalysisTimer) {
                    clearInterval(aiAnalysisTimer);
                    aiAnalysisTimer = null;
                }
            }
        }

        function autoExecuteRecommendations() {
            if (!autoMode) return;
            
            console.log('🤖 Auto mode: Executing high priority recommendations...');
            
            // Auto-approve high priority recommendations
            const highPriorityRecs = currentRecommendations.filter(rec => 
                rec.priority === 'high' && rec.status === 'pending'
            );
            
            highPriorityRecs.forEach(rec => {
                console.log(`🤖 Auto-approving: ${rec.title}`);
                approveRecommendation(rec.id);
            });
            
            // For medium priority, randomly approve some (simulate AI confidence)
            const mediumPriorityRecs = currentRecommendations.filter(rec => 
                rec.priority === 'medium' && rec.status === 'pending'
            );
            
            mediumPriorityRecs.forEach(rec => {
                if (Math.random() > 0.6) { // 40% auto-approval rate for medium priority
                    console.log(`🤖 Auto-approving medium priority: ${rec.title}`);
                    setTimeout(() => approveRecommendation(rec.id), Math.random() * 2000);
                }
            });
        }

        // Initialize agentic AI system
        // Traffic Optimization System
        const trafficData = {
            trucks: [
                { id: 'TRK001', location: 'Terminal Island', destination: 'Warehouse District', status: 'moving', delay: 12 },
                { id: 'TRK002', location: 'Vincent Thomas Bridge', destination: 'Container Terminal', status: 'delayed', delay: 25 },
                { id: 'TRK003', location: 'Harbor Freeway', destination: 'Rail Yard', status: 'moving', delay: 5 },
                { id: 'TRK004', location: 'Pier 400', destination: 'Storage Area', status: 'congested', delay: 30 },
                { id: 'TRK005', location: 'World Cruise Center', destination: 'Maintenance Dock', status: 'moving', delay: 8 }
            ],
            alerts: [
                { id: 1, type: 'congestion', severity: 'high', location: 'Vincent Thomas Bridge', description: 'Heavy traffic due to construction', time: '2 min ago', affected: 'trucks' },
                { id: 2, type: 'accident', severity: 'critical', location: 'Terminal Island Freeway', description: 'Vehicle incident blocking 2 lanes', time: '5 min ago', affected: 'both' },
                { id: 3, type: 'construction', severity: 'medium', location: 'Pier 300 Access Road', description: 'Lane closure for maintenance', time: '15 min ago', affected: 'trucks' },
                { id: 4, type: 'weather', severity: 'low', location: 'Harbor Area', description: 'Light fog reducing visibility', time: '22 min ago', affected: 'both' },
                { id: 5, type: 'congestion', severity: 'medium', location: 'Container Terminal', description: 'High container pickup volume', time: '8 min ago', affected: 'trucks' }
            ],
            routes: [
                { 
                    id: 'R001', 
                    truck: 'TRK002', 
                    original: 'Vincent Thomas Bridge → Container Terminal', 
                    suggested: 'Harbor Freeway → Terminal Island → Container Terminal',
                    savings: { time: '18 min', fuel: '2.3 gal', cost: '$12' },
                    reason: 'Avoiding bridge construction congestion'
                },
                {
                    id: 'R002',
                    truck: 'TRK004',
                    original: 'Pier 400 → Storage Area',
                    suggested: 'Pier 400 → Back Channel → Storage Area',
                    savings: { time: '12 min', fuel: '1.8 gal', cost: '$8' },
                    reason: 'Bypassing container terminal congestion'
                },
                {
                    id: 'R003',
                    employee: 'Staff Shuttle',
                    original: 'Admin Building → Maintenance Yard',
                    suggested: 'Admin Building → East Channel → Maintenance Yard',
                    savings: { time: '8 min', fuel: '0.9 gal', cost: '$5' },
                    reason: 'Avoiding peak traffic on main routes'
                }
            ]
        };

        function showTrafficView(view) {
            document.querySelectorAll('.traffic-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.traffic-view').forEach(v => v.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(view === 'live' ? 'liveTraffic' : view === 'routes' ? 'routePlanning' : 'activeAlerts').classList.add('active');
            
            if (view === 'live') {
                updateLiveAlerts();
            } else if (view === 'routes') {
                updateRouteRecommendations();
            } else if (view === 'alerts') {
                updateAlertsList();
            }
        }

        function updateLiveAlerts() {
            const liveAlertsContainer = document.getElementById('liveAlerts');
            const recentAlerts = trafficData.alerts.slice(0, 3);
            
            liveAlertsContainer.innerHTML = `
                <div style="color: #f59e0b; font-weight: 600; margin-bottom: 0.8rem; font-size: 0.9rem;">🚨 Current Traffic Alerts</div>
                ${recentAlerts.map(alert => `
                    <div class="alert-item">
                        <div class="alert-severity severity-${alert.severity}"></div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.location}</div>
                            <div class="alert-details">${alert.description}</div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                        <button class="alert-action" onclick="resolveAlert(${alert.id})">View</button>
                    </div>
                `).join('')}
            `;
        }

        function updateRouteRecommendations() {
            const routeContainer = document.getElementById('routeSuggestions');
            
            routeContainer.innerHTML = `
                <div style="color: #0ea5e9; font-weight: 600; margin-bottom: 0.8rem; font-size: 0.9rem;">🛣️ AI Route Recommendations</div>
                ${trafficData.routes.map(route => `
                    <div class="route-item">
                        <div class="route-content">
                            <div class="route-title">${route.truck || route.employee}</div>
                            <div class="route-details">Suggested: ${route.suggested}</div>
                            <div class="route-time">${route.reason}</div>
                            <div class="route-savings">
                                <div class="savings-item">⏱️ ${route.savings.time}</div>
                                <div class="savings-item">⛽ ${route.savings.fuel}</div>
                                <div class="savings-item">💰 ${route.savings.cost}</div>
                            </div>
                        </div>
                        <button class="route-action" onclick="applyRoute('${route.id}')">Apply</button>
                    </div>
                `).join('')}
            `;
        }

        function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            
            alertsList.innerHTML = `
                <div style="color: #dc2626; font-weight: 600; margin-bottom: 0.8rem; font-size: 0.9rem;">⚠️ All Traffic Alerts</div>
                ${trafficData.alerts.map(alert => `
                    <div class="alert-item">
                        <div class="alert-severity severity-${alert.severity}"></div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.location} - ${alert.type.toUpperCase()}</div>
                            <div class="alert-details">${alert.description} (Affects: ${alert.affected})</div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                        <button class="alert-action" onclick="resolveAlert(${alert.id})">Resolve</button>
                    </div>
                `).join('')}
            `;
        }

        function filterAlerts(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let filteredAlerts = trafficData.alerts;
            if (filter === 'critical') {
                filteredAlerts = trafficData.alerts.filter(a => a.severity === 'critical' || a.severity === 'high');
            } else if (filter === 'trucks') {
                filteredAlerts = trafficData.alerts.filter(a => a.affected === 'trucks' || a.affected === 'both');
            } else if (filter === 'employees') {
                filteredAlerts = trafficData.alerts.filter(a => a.affected === 'both');
            }
            
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `
                <div style="color: #dc2626; font-weight: 600; margin-bottom: 0.8rem; font-size: 0.9rem;">⚠️ ${filter.charAt(0).toUpperCase() + filter.slice(1)} Alerts</div>
                ${filteredAlerts.map(alert => `
                    <div class="alert-item">
                        <div class="alert-severity severity-${alert.severity}"></div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.location} - ${alert.type.toUpperCase()}</div>
                            <div class="alert-details">${alert.description} (Affects: ${alert.affected})</div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                        <button class="alert-action" onclick="resolveAlert(${alert.id})">Resolve</button>
                    </div>
                `).join('')}
            `;
        }

        function applyRoute(routeId) {
            const route = trafficData.routes.find(r => r.id === routeId);
            if (route) {
                // Show route on map
                showRouteOnMap(routeId);
                
                alert(`✅ Route applied for ${route.truck || route.employee}!\n\nNew route: ${route.suggested}\n\nEstimated savings:\n⏱️ ${route.savings.time}\n⛽ ${route.savings.fuel}\n💰 ${route.savings.cost}`);
                
                // Simulate route application by updating truck status
                const truck = trafficData.trucks.find(t => t.id === route.truck);
                if (truck) {
                    truck.status = 'rerouted';
                    truck.delay = Math.max(0, truck.delay - 15);
                    updateTruckOnMap(truck.id, truck.status, truck.delay);
                }
            }
        }

        function showRouteOnMap(routeId) {
            const routeOverlay = document.getElementById('routeOverlay');
            routeOverlay.style.display = 'block';
            
            // Hide route after 8 seconds
            setTimeout(() => {
                routeOverlay.style.display = 'none';
            }, 8000);
        }

        function updateTruckOnMap(truckId, status, delay) {
            const truckMarker = document.querySelector(`[data-truck="${truckId}"]`);
            if (truckMarker) {
                // Remove old status classes
                truckMarker.classList.remove('moving', 'delayed', 'congested', 'rerouted');
                
                // Add new status class
                truckMarker.classList.add(status);
                
                // Update info tooltip
                const truckInfo = truckMarker.querySelector('.truck-info');
                if (truckInfo) {
                    truckInfo.innerHTML = `${truckId}<br>${delay}min delay`;
                }
                
                // Add visual feedback for rerouted trucks
                if (status === 'rerouted') {
                    truckMarker.style.filter = 'hue-rotate(120deg) brightness(1.3) saturate(1.2)';
                    truckMarker.style.animation = 'none';
                }
            }
        }

        function animateTruckMovement() {
            // Simulate truck movement every 10 seconds
            setInterval(() => {
                const trucks = document.querySelectorAll('.truck-marker');
                trucks.forEach(truck => {
                    if (truck.classList.contains('moving') || truck.classList.contains('rerouted')) {
                        const currentTop = parseFloat(truck.style.top);
                        const currentLeft = parseFloat(truck.style.left);
                        
                        // Random small movement
                        const newTop = currentTop + (Math.random() - 0.5) * 4;
                        const newLeft = currentLeft + (Math.random() - 0.5) * 4;
                        
                        // Keep within bounds
                        truck.style.top = Math.max(10, Math.min(85, newTop)) + '%';
                        truck.style.left = Math.max(10, Math.min(85, newLeft)) + '%';
                    }
                });
            }, 10000);
        }

        function updateCongestionZones() {
            // Simulate dynamic congestion zone updates
            setInterval(() => {
                const zones = document.querySelectorAll('.congestion-zone');
                zones.forEach(zone => {
                    if (Math.random() > 0.9) {
                        // Randomly change congestion levels
                        const levels = ['medium', 'high', 'critical'];
                        const currentLevel = zone.classList.contains('critical') ? 'critical' : 
                                           zone.classList.contains('high') ? 'high' : 'medium';
                        
                        const newLevel = levels[Math.floor(Math.random() * levels.length)];
                        
                        zone.classList.remove('medium', 'high', 'critical');
                        zone.classList.add(newLevel);
                    }
                });
            }, 20000);
        }

        function initializeMapInteractions() {
            // Add click handlers for congestion zones
            document.querySelectorAll('.congestion-zone').forEach(zone => {
                zone.addEventListener('click', function() {
                    const title = this.getAttribute('title');
                    alert(`Traffic Alert: ${title}\n\nClick on Route Planning to see alternative routes.`);
                });
            });

            // Add click handlers for truck markers
            document.querySelectorAll('.truck-marker').forEach(marker => {
                marker.addEventListener('click', function() {
                    const truckId = this.getAttribute('data-truck');
                    const truck = trafficData.trucks.find(t => t.id === truckId);
                    if (truck) {
                        alert(`${truck.id} Status:\nLocation: ${truck.location}\nDestination: ${truck.destination}\nDelay: ${truck.delay} minutes\nStatus: ${truck.status.toUpperCase()}`);
                    }
                });
            });

            // Add click handlers for port areas
            document.querySelectorAll('.port-area').forEach(area => {
                area.addEventListener('click', function() {
                    const title = this.getAttribute('title');
                    alert(`Port Area: ${title}\n\nAccess this area through the traffic optimization panel.`);
                });
            });
        }

        function resolveAlert(alertId) {
            const alert = trafficData.alerts.find(a => a.id === alertId);
            if (alert) {
                if (confirm(`Mark alert as resolved?\n\n${alert.location}: ${alert.description}`)) {
                    // Remove alert from array
                    trafficData.alerts = trafficData.alerts.filter(a => a.id !== alertId);
                    
                    // Refresh the current view
                    const activeView = document.querySelector('.traffic-view.active').id;
                    if (activeView === 'liveTraffic') updateLiveAlerts();
                    else if (activeView === 'activeAlerts') updateAlertsList();
                }
            }
        }

        function simulateTrafficUpdates() {
            // Simulate new alerts periodically
            setInterval(() => {
                const locations = ['Pier 200', 'Harbor Freeway', 'Terminal Island', 'Container Yard', 'Maintenance Area'];
                const types = ['congestion', 'construction', 'weather', 'equipment'];
                const severities = ['low', 'medium', 'high'];
                const descriptions = [
                    'Heavy traffic reported',
                    'Lane closure due to maintenance',
                    'Equipment malfunction causing delays',
                    'Weather conditions affecting visibility'
                ];
                
                if (Math.random() > 0.7 && trafficData.alerts.length < 8) {
                    const newAlert = {
                        id: Date.now(),
                        type: types[Math.floor(Math.random() * types.length)],
                        severity: severities[Math.floor(Math.random() * severities.length)],
                        location: locations[Math.floor(Math.random() * locations.length)],
                        description: descriptions[Math.floor(Math.random() * descriptions.length)],
                        time: 'Just now',
                        affected: Math.random() > 0.5 ? 'trucks' : 'both'
                    };
                    
                    trafficData.alerts.unshift(newAlert);
                    
                    // Update active view if showing live traffic
                    if (document.getElementById('liveTraffic').classList.contains('active')) {
                        updateLiveAlerts();
                    }
                }
                
                // Update truck delays randomly
                trafficData.trucks.forEach(truck => {
                    if (Math.random() > 0.8) {
                        truck.delay += Math.floor(Math.random() * 10) - 5;
                        truck.delay = Math.max(0, truck.delay);
                        
                        if (truck.delay > 20) truck.status = 'delayed';
                        else if (truck.delay > 10) truck.status = 'congested';
                        else truck.status = 'moving';
                    }
                });
                
                // Update metrics in the overview
                const activeTrucks = document.querySelector('.traffic-overview .metric-number');
                const delayedTrucks = trafficData.trucks.filter(t => t.delay > 10).length;
                const avgDelay = Math.round(trafficData.trucks.reduce((sum, t) => sum + t.delay, 0) / trafficData.trucks.length);
                
                if (activeTrucks) {
                    const metrics = document.querySelectorAll('.traffic-metric');
                    if (metrics[1]) {
                        metrics[1].querySelector('.metric-number').textContent = trafficData.alerts.length;
                        const criticalAlerts = trafficData.alerts.filter(a => a.severity === 'high' || a.severity === 'critical').length;
                        metrics[1].querySelector('.metric-status').textContent = criticalAlerts > 0 ? `${criticalAlerts} Critical` : 'All Clear';
                    }
                    if (metrics[2]) {
                        metrics[2].querySelector('.metric-number').textContent = avgDelay + 'min';
                        const status = metrics[2].querySelector('.metric-status');
                        if (avgDelay < 10) {
                            status.textContent = 'Good';
                            status.className = 'metric-status good';
                        } else if (avgDelay < 20) {
                            status.textContent = 'Warning';
                            status.className = 'metric-status warning';
                        } else {
                            status.textContent = 'Critical';
                            status.className = 'metric-status critical';
                        }
                    }
                }
            }, 15000);
        }

        // Voice Assistant Functionality
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let voiceOutputEnabled = true;
        let synthesis = window.speechSynthesis;
        let recognition = null;

        function initializeVoiceAssistant() {
            // Check for speech recognition support - try browser first for desktop
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile && 'MediaRecorder' in window && 'navigator' in window && 'mediaDevices' in navigator) {
                // Use Google Cloud Speech-to-Text for mobile
                console.log('Mobile detected - using Google Cloud Speech-to-Text');
                updateVoiceStatus('', 'Voice Assistant Ready (Mobile)');
                
                if (!window.GOOGLE_MAPS_API_KEY || window.GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') {
                    updateVoiceStatus('error', '❌ Google API key not configured');
                    document.getElementById('voiceBtn').disabled = true;
                    return;
                }
            } else if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                // Use Web Speech API for desktop
                console.log('Desktop detected - using Web Speech API');
                try {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = function() {
                        updateVoiceStatus('listening', '🎤 Listening...');
                        document.getElementById('voiceBtn').classList.add('recording');
                        document.getElementById('voiceIndicator').classList.add('active');
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        updateVoiceStatus('', '🤖 Analyzing...');
                        
                        // Auto-send the message immediately
                        sendMessage();
                    };
                    
                    recognition.onerror = function(event) {
                        let errorMessage = '❌ Speech error';
                        
                        switch(event.error) {
                            case 'not-allowed':
                                errorMessage = '❌ Microphone permission denied. Please allow microphone access.';
                                break;
                            case 'no-speech':
                                errorMessage = '⚠️ No speech detected. Try speaking louder.';
                                break;
                            case 'audio-capture':
                                errorMessage = '❌ Microphone not found. Check your microphone.';
                                break;
                            case 'network':
                                errorMessage = '❌ Network error. Check your internet connection.';
                                break;
                            default:
                                errorMessage = `❌ Speech error: ${event.error}`;
                        }
                        
                        updateVoiceStatus('error', errorMessage);
                        setTimeout(() => {
                            updateVoiceStatus('', 'Voice Assistant Ready');
                        }, 3000);
                    };
                    
                    recognition.onend = function() {
                        isRecording = false;
                        document.getElementById('voiceBtn').classList.remove('recording');
                        document.getElementById('voiceIndicator').classList.remove('active');
                        if (!document.getElementById('voiceStatus').classList.contains('error')) {
                            updateVoiceStatus('', 'Voice Assistant Ready');
                        }
                    };

                    updateVoiceStatus('', 'Voice Assistant Ready (Desktop)');
                    
                } catch (error) {
                    console.error('Error initializing speech recognition:', error);
                    updateVoiceStatus('error', '❌ Failed to initialize speech recognition');
                    document.getElementById('voiceBtn').disabled = true;
                }
            } else {
                updateVoiceStatus('error', '❌ Speech recognition not supported in this browser');
                document.getElementById('voiceBtn').disabled = true;
            }
            
            document.getElementById('voiceToggleBtn').classList.add('active');
        }

        let silenceTimer = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;

        async function startGoogleSpeechRecognition() {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                updateVoiceStatus('listening', '🎤 Listening... speak now');
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('voiceIndicator').classList.add('active');
                
                // Set up audio analysis for silence detection
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 512;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                // Initialize MediaRecorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Stop all tracks to release microphone
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Clean up audio context
                    if (audioContext) {
                        audioContext.close();
                        audioContext = null;
                    }
                    
                    updateVoiceStatus('', '🔄 Processing speech...');
                    
                    try {
                        const transcript = await sendAudioToGoogle(audioBlob);
                        if (transcript && transcript.trim()) {
                            document.getElementById('chatInput').value = transcript;
                            updateVoiceStatus('', '🤖 Analyzing...');
                            
                            // Auto-send the message immediately
                            sendMessage();
                        } else {
                            updateVoiceStatus('error', '⚠️ No speech detected. Try speaking louder.');
                            setTimeout(() => {
                                updateVoiceStatus('', 'Voice Assistant Ready');
                            }, 3000);
                        }
                    } catch (error) {
                        console.error('Google Speech API error:', error);
                        updateVoiceStatus('error', '❌ Speech processing failed. Try again.');
                        setTimeout(() => {
                            updateVoiceStatus('', 'Voice Assistant Ready');
                        }, 3000);
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Start silence detection
                detectSilence();
                
                // Fallback auto-stop after 15 seconds
                setTimeout(() => {
                    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                        updateVoiceStatus('', '⏰ Maximum recording time reached');
                        stopGoogleSpeechRecognition();
                    }
                }, 15000);
                
            } catch (error) {
                console.error('Microphone access error:', error);
                let errorMessage = '❌ Microphone access denied';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = '❌ Microphone permission denied. Please allow microphone access.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '❌ No microphone found. Check your microphone connection.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '❌ Microphone is being used by another application.';
                }
                
                updateVoiceStatus('error', errorMessage);
                setTimeout(() => {
                    updateVoiceStatus('', 'Voice Assistant Ready');
                }, 3000);
            }
        }

        function detectSilence() {
            if (!isRecording || !analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Calculate average volume
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            
            // Threshold for detecting speech (adjust as needed)
            const speechThreshold = 10;
            
            if (average > speechThreshold) {
                // Speech detected, clear silence timer
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                updateVoiceStatus('listening', '🎤 Listening... keep speaking');
            } else {
                // Silence detected, start/continue timer
                if (!silenceTimer) {
                    updateVoiceStatus('listening', '🎤 Listening... silence detected');
                    silenceTimer = setTimeout(() => {
                        if (isRecording) {
                            updateVoiceStatus('', '🔇 Silence detected, processing...');
                            stopGoogleSpeechRecognition();
                        }
                    }, 2000); // Stop after 2 seconds of silence
                }
            }
            
            // Continue monitoring
            if (isRecording) {
                requestAnimationFrame(detectSilence);
            }
        }

        function stopGoogleSpeechRecognition() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            isRecording = false;
            
            // Clear silence timer
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            
            document.getElementById('voiceBtn').classList.remove('recording');
            document.getElementById('voiceIndicator').classList.remove('active');
        }

        async function sendAudioToGoogle(audioBlob) {
            // Convert webm to base64
            const base64Audio = await blobToBase64(audioBlob);
            const audioContent = base64Audio.split(',')[1]; // Remove data:audio/webm;base64, prefix
            
            const requestBody = {
                config: {
                    encoding: 'WEBM_OPUS',
                    sampleRateHertz: 16000,
                    languageCode: 'en-US',
                    enableAutomaticPunctuation: true,
                    model: 'latest_short'
                },
                audio: {
                    content: audioContent
                }
            };

            const response = await fetch(`https://speech.googleapis.com/v1/speech:recognize?key=${window.GOOGLE_MAPS_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Google Speech API error:', errorData);
                throw new Error(`Google Speech API error: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                return data.results[0].alternatives[0].transcript;
            } else {
                return null;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function toggleVoiceRecording() {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Use Google Cloud Speech-to-Text for mobile
                if (isRecording) {
                    stopGoogleSpeechRecognition();
                } else {
                    startGoogleSpeechRecognition();
                }
            } else {
                // Use Web Speech API for desktop
                if (!recognition) return;
                
                if (isRecording) {
                    recognition.stop();
                    isRecording = false;
                } else {
                    recognition.start();
                    isRecording = true;
                }
            }
        }

        function toggleVoiceOutput() {
            voiceOutputEnabled = !voiceOutputEnabled;
            const btn = document.getElementById('voiceToggleBtn');
            
            if (voiceOutputEnabled) {
                btn.classList.add('active');
                btn.title = 'Voice responses enabled';
                updateVoiceStatus('', 'Voice responses enabled');
            } else {
                btn.classList.remove('active');
                btn.title = 'Voice responses disabled';
                updateVoiceStatus('', 'Voice responses disabled');
            }
            
            // Stop any current speech
            synthesis.cancel();
        }

        function updateVoiceStatus(className, text) {
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceStatusText = document.querySelector('.voice-status-text');
            
            voiceStatus.className = 'voice-status ' + className;
            voiceStatusText.textContent = text;
        }

        async function speakText(text) {
            if (!voiceOutputEnabled) return;
            
            // Cancel any current speech
            if (synthesis) {
                synthesis.cancel();
            }
            
            try {
                updateVoiceStatus('speaking', '🔊 Speaking...');
                
                // Use Google Cloud Text-to-Speech API
                const audioBuffer = await generateSpeechWithGoogle(text);
                
                // Play the audio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createBufferSource();
                
                const decodedData = await audioContext.decodeAudioData(audioBuffer);
                source.buffer = decodedData;
                source.connect(audioContext.destination);
                
                source.onended = function() {
                    updateVoiceStatus('', 'Voice Assistant Ready');
                };
                
                source.start(0);
                
            } catch (error) {
                console.error('Google TTS error:', error);
                
                // Fallback to browser speech synthesis
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                utterance.onstart = function() {
                    updateVoiceStatus('speaking', '🔊 Speaking...');
                };
                
                utterance.onend = function() {
                    updateVoiceStatus('', 'Voice Assistant Ready');
                };
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                    updateVoiceStatus('error', '❌ Speech output error');
                };
                
                if (synthesis) {
                    synthesis.speak(utterance);
                }
            }
        }

        async function generateSpeechWithGoogle(text) {
            const requestBody = {
                input: { text: text },
                voice: {
                    languageCode: 'en-US',
                    name: 'en-US-Neural2-F',
                    ssmlGender: 'FEMALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    speakingRate: 1.0,
                    pitch: 0.0,
                    volumeGainDb: 0.0
                }
            };

            const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${window.GOOGLE_MAPS_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Google TTS API error:', errorData);
                throw new Error(`Google TTS API error: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.audioContent) {
                // Convert base64 to ArrayBuffer
                const binaryString = atob(data.audioContent);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            } else {
                throw new Error('No audio content received from Google TTS');
            }
        }


        // Streaming text functionality with real-time speech
        function streamText(element, text, speed = 30) {
            return new Promise((resolve) => {
                element.textContent = '';
                element.classList.add('streaming');
                let index = 0;
                let currentSentence = '';
                let sentences = [];
                let speechQueue = [];
                let isSpeaking = false;
                
                // Split text into sentences for real-time speech
                const sentenceEnders = /[.!?]+/g;
                const textSentences = text.split(sentenceEnders).filter(s => s.trim().length > 0);
                
                async function playNextSpeech() {
                    console.log('playNextSpeech called - Queue length:', speechQueue.length, 'Voice enabled:', voiceOutputEnabled, 'Is speaking:', isSpeaking);
                    
                    if (speechQueue.length > 0 && voiceOutputEnabled && !isSpeaking) {
                        isSpeaking = true;
                        const sentence = speechQueue.shift();
                        console.log('Playing speech for sentence:', sentence);
                        
                        try {
                            updateVoiceStatus('speaking', '🔊 Speaking...');
                            await speakTextRealtime(sentence);
                            console.log('Speech completed for:', sentence);
                        } catch (error) {
                            console.error('Real-time speech error:', error);
                        }
                        
                        isSpeaking = false;
                        updateVoiceStatus('', 'Voice Assistant Ready');
                        
                        // Continue with next sentence
                        setTimeout(playNextSpeech, 100);
                    } else {
                        console.log('Speech not played - conditions not met');
                    }
                }
                
                function typeCharacter() {
                    if (index < text.length) {
                        const char = text.charAt(index);
                        element.textContent += char;
                        currentSentence += char;
                        index++;
                        
                        // Check if we completed a sentence
                        if (/[.!?]/.test(char) && currentSentence.trim().length > 5) {
                            const completeSentence = currentSentence.trim();
                            console.log('Sentence completed:', completeSentence);
                            
                            if (completeSentence) {
                                speechQueue.push(completeSentence);
                                currentSentence = '';
                                
                                // Start playing speech if not already playing
                                if (!isSpeaking && voiceOutputEnabled) {
                                    console.log('Starting speech for:', completeSentence);
                                    playNextSpeech();
                                } else {
                                    console.log('Speech queued (already speaking or disabled):', isSpeaking, voiceOutputEnabled);
                                }
                            }
                        }
                        
                        // Scroll to bottom as text appears
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        setTimeout(typeCharacter, speed);
                    } else {
                        // Handle any remaining text that didn't end with punctuation
                        if (currentSentence.trim().length > 0) {
                            console.log('Final sentence:', currentSentence.trim());
                            speechQueue.push(currentSentence.trim());
                            if (!isSpeaking && voiceOutputEnabled) {
                                playNextSpeech();
                            }
                        }
                        
                        element.classList.remove('streaming');
                        resolve();
                    }
                }
                
                typeCharacter();
            });
        }

        // Real-time speech function (faster, optimized for streaming)
        async function speakTextRealtime(text) {
            if (!voiceOutputEnabled || !text.trim()) {
                console.log('Speech skipped - voice disabled or empty text');
                return;
            }
            
            console.log('Starting speech synthesis for:', text);
            
            // Use browser speech synthesis first for reliability
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 0.9;
                
                utterance.onstart = function() {
                    console.log('Speech started for:', text);
                };
                
                utterance.onend = function() {
                    console.log('Speech ended for:', text);
                    resolve();
                };
                
                utterance.onerror = function(event) {
                    console.error('Speech error:', event.error, 'for text:', text);
                    resolve(); // Continue even if speech fails
                };
                
                if (synthesis) {
                    synthesis.cancel(); // Cancel any previous speech
                    synthesis.speak(utterance);
                } else {
                    console.error('Speech synthesis not available');
                    resolve();
                }
            });
        }

        // Modify existing sendMessage function to include streaming and voice output
        const originalSendMessage = window.sendMessage;
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                
                // Add user message
                const userDiv = document.createElement('div');
                userDiv.className = 'chat-message user';
                userDiv.textContent = message;
                chatMessages.appendChild(userDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-message ai typing';
                typingDiv.innerHTML = '<span class="typing-indicator">POLA is thinking...</span>';
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Clear input
                input.value = '';
                
                // Simulate AI processing time
                setTimeout(async () => {
                    // Remove typing indicator
                    chatMessages.removeChild(typingDiv);
                    
                    // Create AI response div
                    const aiDiv = document.createElement('div');
                    aiDiv.className = 'chat-message ai';
                    chatMessages.appendChild(aiDiv);
                    
                    // Get AI response
                    let response = getAIResponse(message);
                    
                    // Stream the text output with real-time speech
                    await streamText(aiDiv, response, 25); // 25ms delay between characters
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1500); // 1.5 second "thinking" time
            }
        };

        function getAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('traffic') || lowerMessage.includes('congestion')) {
                return "Currently monitoring 47 active trucks with 2 critical congestion zones at Vincent Thomas Bridge and Terminal Island Freeway. Alternative routes have been calculated to reduce delays by up to 18 minutes.";
            } else if (lowerMessage.includes('weather') || lowerMessage.includes('fog')) {
                return "Current weather conditions show light fog reducing visibility in the harbor area. All vessels are operating under enhanced navigation protocols with AIS tracking active for 1,247 tracked vessels.";
            } else if (lowerMessage.includes('status') || lowerMessage.includes('operations')) {
                return "Port operations are running smoothly. All 8 global ports in the network are connected with latency under 15ms. 47 edge computing nodes are operational with real-time data fusion from 23 integrated systems.";
            } else if (lowerMessage.includes('alert') || lowerMessage.includes('emergency')) {
                return "Current alert status: 3 active alerts including 1 critical incident at Terminal Island Freeway and moderate congestion at Container Terminal. Emergency protocols are ready and autonomous systems are monitoring the situation.";
            } else if (lowerMessage.includes('vessel') || lowerMessage.includes('ship')) {
                return "Vessel tracking is active with AIS data from 1,247 tracked vessels. Bathymetry 4D model is operational and tidal data shows +2.3ft rising. All terminals are processing vessels according to schedule.";
            } else {
                return "I'm POLA's AI assistant. I can help you with traffic optimization, vessel tracking, operational status, weather conditions, and emergency alerts. What would you like to know?";
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🤖 Initializing Agentic AI Workflow System...');
            console.log('🚛 Initializing Traffic Optimization System...');
            console.log('🗺️ Initializing Interactive Map Features...');
            console.log('🎤 Initializing Voice Assistant...');
            
            // Initialize voice assistant
            initializeVoiceAssistant();
            
            // Initialize traffic optimization
            updateLiveAlerts();
            simulateTrafficUpdates();
            
            // Initialize map interactions
            initializeMapInteractions();
            animateTruckMovement();
            updateCongestionZones();
            
            // Perform initial scan after a short delay
            setTimeout(() => {
                triggerAIScan();
            }, 3000);
        });
    </script>
</body>
</html>
                    